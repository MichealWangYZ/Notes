\documentclass[hyperref, UTF8, a4paper]{ctexart}

\usepackage{geometry}
\usepackage{titling}
\usepackage{titlesec}
\usepackage{paralist}
\usepackage{footnote}
\usepackage{enumerate}
\usepackage{amsmath, amssymb, amsthm}
\usepackage{bbm}
\usepackage{cite}
\usepackage{graphicx}
\usepackage{subfigure}
\usepackage{physics}
\usepackage{tikz}
\usepackage{autobreak}
\usepackage[ruled, vlined, linesnumbered, noend]{algorithm2e}
\usepackage[colorlinks, linkcolor=black, anchorcolor=black, citecolor=black]{hyperref}
\usepackage{prettyref}

% Page style
\geometry{left=3.18cm,right=3.18cm,top=2.54cm,bottom=2.54cm}
\titlespacing{\paragraph}{0pt}{1pt}{10pt}[20pt]
\setlength{\droptitle}{-5em}
\preauthor{\vspace{-10pt}\begin{center}}
\postauthor{\par\end{center}}

% Math operators
\DeclareMathOperator{\timeorder}{T}
\DeclareMathOperator{\diag}{diag}
\DeclareMathOperator{\legpoly}{P}
\DeclareMathOperator{\primevalue}{P}
\DeclareMathOperator{\sgn}{sgn}
\newcommand*{\ii}{\mathrm{i}}
\newcommand*{\ee}{\mathrm{e}}
\newcommand*{\const}{\mathrm{const}}
\newcommand*{\comment}{\paragraph{注记}}
\newcommand*{\suchthat}{\quad \text{s.t.} \quad}
\newcommand*{\argmin}{\arg\min}
\newcommand*{\argmax}{\arg\max}
\newcommand*{\normalorder}[1]{: #1 :}
\newcommand*{\pair}[1]{\langle #1 \rangle}
\newcommand*{\fd}[1]{\mathcal{D} #1}
\DeclareMathOperator{\bigO}{\mathcal{O}}

% prettyref setting
\newrefformat{sec}{第\ref{#1}节}
\newrefformat{note}{注\ref{#1}}
\newrefformat{fig}{图\ref{#1}}
\newrefformat{alg}{算法\ref{#1}}
\renewcommand{\autoref}{\prettyref}

% TikZ setting
\usetikzlibrary{arrows,shapes,positioning}
\usetikzlibrary{arrows.meta}
\usetikzlibrary{decorations.markings}
\tikzstyle arrowstyle=[scale=1]
\tikzstyle directed=[postaction={decorate,decoration={markings,
    mark=at position .5 with {\arrow[arrowstyle]{stealth}}}}]
\tikzstyle ray=[directed, thick]
\tikzstyle dot=[anchor=base,fill,circle,inner sep=1pt]

% Algorithm setting
\renewcommand{\algorithmcfname}{算法}
% Python-style code
\SetKwIF{If}{ElseIf}{Else}{if}{:}{elif:}{else:}{}
\SetKwFor{For}{for}{:}{}
\SetKwFor{While}{while}{:}{}
\SetKwInput{KwData}{输入}
\SetKwInput{KwResult}{输出}
\SetArgSty{textnormal}

\renewcommand{\emph}[1]{\textbf{#1}}
\newcommand*{\concept}[1]{{\textbf{#1}}}

\title{蒙特卡罗方法}
\author{吴何友}

\begin{document}

\maketitle

\section{经典蒙特卡洛方法}

\subsection{马尔科夫链蒙特卡洛方法}\label{sec:mcmc-method}

平衡态统计物理的核心问题就是计算配分函数
\begin{equation}
    Z = \sum_\mathcal{C} \ee^{-\beta H[\mathcal{C}]} = \sum_\mathcal{C} W(\mathcal{C}).
    \label{eq:partition-function}
\end{equation}
这里我们用$\mathcal{C}$表示一个任意的系统能量本征态，经典情况下这就是一个系统构型，量子情况下还需要对哈密顿量做一个对角化。
本节将主要讨论经典系统，因为它不涉及通常难以计算的算符对角化，并且实际上很多时候量子系统可以化归为经典系统。
如果能够将每个$\mathcal{C}$对应的$W[\mathcal{C}]$算出来那还可以大大简化期望值的计算。

显然，涉及系统构型的路径积分\eqref{eq:partition-function}是非常难以计算的。这是因为实际的系统中的构型数目可以非常大，例如设一个格点系统每个格点的状态有$s$个取值，那么总的状态数就是$s^N$。
最关键的是，我们实际上也不需要将所有系统构型的概率都算出来，因为大部分构型的概率都不大，我们只需要一系列出现次数大致正比于其出现概率的“代表性构型”就可以了。
这种思路导致了\concept{马尔科夫链蒙特卡洛法（MCMC）}，即构造一个各态遍历、不可约的马尔可夫链
\[
    \cdots \longrightarrow \mathcal{C}_{i-1} \longrightarrow \mathcal{C}_i \longrightarrow \mathcal{C}_{i+1} \longrightarrow \cdots,
\]
使得
\begin{equation}
    \frac{p(\mathcal{C} \rightarrow \mathcal{D})}{p(\mathcal{D} \rightarrow \mathcal{C})} = \frac{W(\mathcal{D})}{W(\mathcal{C})} = \ee^{-\beta(H[\mathcal{D}]-H[\mathcal{C}])},
    \label{eq:markov-mcmc}
\end{equation}
则达到平衡时必定有细致平衡条件
\[
    p(\mathcal{C}) p(\mathcal{C} \rightarrow \mathcal{D}) = p(\mathcal{D}) p(\mathcal{D} \rightarrow \mathcal{C}),
\]
就有
\[
    \frac{W(\mathcal{D})}{W(\mathcal{C})} = \frac{p(\mathcal{D})}{p(\mathcal{C})}.
\]
专门使用$\pi(\mathcal{C})$来表示平衡态概率，即有
\begin{equation}
    \frac{W(\mathcal{D})}{W(\mathcal{C})} = \frac{\pi(\mathcal{D})}{\pi(\mathcal{C})}.
\end{equation}
这样我们只需要让这个马尔可夫链计算到收敛（有限、时不变、不可约、非循环的马尔科夫链肯定可以收敛，而由于可以找到一个$p(\mathcal{C})$的安排让细致平衡条件成立，总是可以收敛到$W(\mathcal{C})/Z$），
此时按照系综平均等于时间平均的原理，任何一个物理量的期望值就是
\begin{equation}
    \expval{O} = \sum_{\mathcal{C}} \frac{W(\mathcal{C})}{Z} O[\mathcal{C}] = \frac{1}{N} \sum_i O[\mathcal{C}_i].
    \label{eq:classical-expectation}
\end{equation}
也即过程收敛之后（收敛之前的过程称为\concept{热化}，这一段数据并不是特别有用），只需要在时间序列$\{\mathcal{C}_i\}$上分别计算$O$的值，做时间平均，就得到了$O$的期望值。
需要注意的是实际上$N$不能取无穷大，因此我们希望平衡之后$\{\mathcal{C}_i\}$尽可能随机，即自相关要足够小。
马尔科夫链普遍具有这样的性质：由于每一时刻的状态只和前一时刻有关，后一时刻和前一时刻的分布不是独立的，但是随着时间推移，自相关会指数衰减，即
\begin{equation}
    A(\Delta t) = \frac{\expval*{O(t+\Delta t) Q(t)} - \expval*{O(t)}^2}{\expval*{O(t)^2} - \expval*{O(t)}^2} \sim \ee^{- \Delta t / \tau}.
\end{equation}
如果我们需要抽取$N$个彼此统计无关的平衡态构型作为样本计算期望值，那么计算一个期望值的时间复杂度就是
\begin{equation}
    \bigO(t) \sim \bigO(\text{one step}) \cdot \tau \cdot N,
\end{equation}
因为两个不相关的样本之间大约有$\tau$的时间。

因此问题的核心就是如何设计一个满足\eqref{eq:markov-mcmc}的不可约各态历经马尔可夫链。
这个过程未必要和实际的动力学过程完全一样，只要满足\eqref{eq:markov-mcmc}当然都可以。
不可约性相对来说是容易做到的，因此需要巧妙地设计$p(\mathcal{C} \rightarrow \mathcal{D})$，并且确认平衡后的$\{\mathcal{C}_i\}$在长时间上没有自相关。

最后注意一点：实际上在以上推导中我们根本就没有使用过$W(\mathcal{C})$构成一个玻尔兹曼分布这一条件。
因此，经典蒙特卡洛法实际上可以用于任何抽样问题。

\subsection{Metropolis-Hastings算法}

本节讨论一个能够达到\autoref{sec:mcmc-method}中要求的算法：Metropolis-Hastings算法，即\autoref{alg:metro-hast}。

\begin{algorithm}[H]

    \DontPrintSemicolon
    \SetAlgoLined

    \KwData{不同构型$\mathcal{C}$对应的$W[\mathcal{C}]$，计算步数$N$，一个容易抽样的分布$Q(\mathcal{C}' | \mathcal{C}_0)$}
    \KwResult{序列$\{\mathcal{C}_t\}$}
    
    选定一个初始状态$\mathcal{C}_0$\;
    $t=0$\;
    \While{$t<N$}{
        从分布$Q(\mathcal{C}' | \mathcal{C}_t)$中抽样出$\mathcal{C}'$，这个过程称为\concept{提议} \;
        $A(\mathcal{C}' | \mathcal{C}_t) = \min(1, \frac{W(\mathcal{C}') Q(\mathcal{C}_t | \mathcal{C}')}{W(\mathcal{C}_t) Q(\mathcal{C}' | \mathcal{C}_t)})$\;
        从$[0,1]$的均匀分布抽样出$u$\;
        \eIf{$u \leq A(\mathcal{C}' | \mathcal{C}_t)$}{
            $\mathcal{C}_{t+1} = \mathcal{C}'$，这称为\concept{接受}提议 \;
        }{
            $\mathcal{C}_{t+1} = \mathcal{C}_t$，这称为\concept{拒绝}提议 \; 
        }
    }
    \Return{序列$\{\mathcal{C}_i\}$}\;

    \caption{Metropolis-Hastings算法}
    \label{alg:metro-hast}
\end{algorithm}

从\autoref{alg:metro-hast}中很容易看出，提议$\mathcal{C}'$被接受的概率（也就是所谓的\concept{接受率}）为
\begin{equation}
    p(\mathcal{C} \to \mathcal{C}') = Q(\mathcal{C}' | \mathcal{C}) A(\mathcal{C}' | \mathcal{C}) = Q(\mathcal{C}' | \mathcal{C}) \min \left(1, \frac{W(\mathcal{C}') Q(\mathcal{C} | \mathcal{C}')}{W(\mathcal{C}) Q(\mathcal{C}' | \mathcal{C})} \right).
    \label{eq:prob-metro-hast}
\end{equation}
分类讨论可以发现\eqref{eq:markov-mcmc}的确是成立的。
只要我们保证$Q(\mathcal{C} | \mathcal{C}')$描述的马尔可夫链是不可约的，那么\eqref{eq:prob-metro-hast}描述的马尔可夫链就是不可约的，因为随意两个构型之间都能够跃迁。
因此，只要$Q(\mathcal{C} | \mathcal{C}')$描述的马尔可夫链不可约，Metropolis-Hastings算法一定是一个好的马尔可夫链蒙特卡洛方法。

虽然原则上$Q(\mathcal{C}' | \mathcal{C})$的选取不影响结果，但实际计算中不同的选择可以非常大地改变模拟的效率和质量。
例如，如果让$Q$比较大的$\mathcal{C}'$和$\mathcal{C}$几乎完全无关，那么$\mathcal{C}_t$很可能几乎总是在能量很大的构型附近徘徊，而不发生更新，从而算法需要特别长的时间才能真正收敛；甚至这可能让人误以为那些能量较高的构型已经收敛了。
因此通常采用局部更新的策略，即每次提议只尝试更动少数几个格点。

不过，局部更新的策略并不总是适用的。在临界点附近，有大量长程关联，局部更新是非常缓慢的，这称为\concept{临界慢化}。
此时需要别的策略来做更新。

\subsection{结果评估}

结果评估通常需要两个因素：一个是关联时间（用来评价采样是否足够均匀），一个是标准差（用来评价由于数据波动导致的误差有多大）。

为了方便起见，会使用binning技术来评估这两个因素，即把计算历史分割成一系列共计$M$个等长的连续区段，计算每一段的平均值，（用$O_i^{(M)}$表示），然后计算所有bin的平均值的标准差
\begin{equation}
    \Delta_M = \sqrt{\frac{1}{M(M-1)} \sum_{i=1}^M (O_i^{(M)} - \overline{O^{(M)}})^2},
\end{equation}
如果$M$非常接近$N$，那么$\Delta_M$就是直接使用计算历史$\{O_i\}$计算出来的标准差。反之，如果$M=1$，那么就根本没有标准差，因为只有非常少的数据点。
随着$M$的增大，标准差会不断增大，然后趋于平缓。标准差开始趋于平缓时，不同的区段之间就应该基本上不相关了，因为这说明一个区段携带的信息实际上基本上就是这个区段的平均值提供的信息。
这就给了我们一种非常便捷的估算数据标准差（从而可以给计算结果标上误差棒）的方法：从比较小的$M$开始不断增加，直至标准差上升平缓，此时的$\Delta_M$就近似为实际的标准差，且$\Delta \tau$约等于此时的$N/M$。

\section{量子蒙特卡洛概述}

现在我们转而分析量子平衡态统计系统。在本文中，如果我们要讨论空间坐标，一律默认为格点系统，设其维数为$d$。
特别讨论格点上的系统是因为这是固体物理中最为常见的模型，并且原则上，连续空间中的物理总是可以离散化为格点上的物理。
在计算配分函数时，量子的平衡态统计系统和经典的不同之处在于：
\begin{itemize}
    \item 配分函数的$\ee$指数上并不是简单的$\beta$乘以哈密顿量，而是哈密顿量加上一个$\pi \partial_\tau \phi$项以后对虚时间做积分，积分限为$0$到$\beta$。（在$\beta$很小——也即，在高温极限下——这个积分当然就等于哈密顿量乘以$\beta$）
    \item “每个格点上的粒子具有确定的状态”未必是能量本征态，换句话说偏好基未必是能量本征态。
    \item 由于系统状态是态矢量，难以定义“随机更新系统的状态”；
    \item 计算任务的多样化：可能要计算系综平均值\eqref{eq:classical-expectation}，实际上就是要计算
    \begin{equation}
        \expval{O} = \frac{\trace(\hat{O} \ee^{-\beta \hat{H}})}{\trace \ee^{-\beta \hat{H}}},
        \label{eq:quantum-expectation}
    \end{equation}
    也可能要计算基态能量，由于基态能量最低，如果基态不简并则很容易验证它就是
    \begin{equation}
        \ket{\Psi_0} = \lim_{\tau \to \infty} \ee^{-\tau \hat{H}} \ket{\Psi},
        \label{eq:ground-state-infty}
    \end{equation}
    其中$\ket{\Psi}$是任意一个态矢量，从而期望值为
    \begin{equation}
        \expval{O} = \lim_{\tau \to \infty} \frac{\mel{\Psi}{\ee^{-\tau \hat{H}} \hat{O} \ee^{-\tau \hat{H}}}{\Psi}}{\mel{\Psi}{\ee^{-2\tau \hat{H}}}{\Psi}}.
    \end{equation}
\end{itemize}
由于前两个原因，计算每个系统构型（在这里以“每个格点上有某种状态的粒子”为表象）对应的未归一化概率$W(\mathcal{C})$是非常困难的。
例如，如果要计算系综期望值，使用\eqref{eq:classical-expectation}依照定义计算上式计算量非常大；当然，可以首先将哈密顿量对角化，但对复杂的系统这基本上不可能完成。
归根到底，量子力学允许态做线性叠加的特点意味着系统可以取的状态相比于经典力学不成比例得多，因此不能够简单地将经典蒙特卡洛的方法推广到量子蒙特卡洛，而只能尝试将量子问题化归到一个经典蒙特卡洛采样问题上。

不同的计算任务还要求不同的算法。例如\eqref{eq:quantum-expectation}对应的问题称为\concept{有限温度量子蒙特卡洛（Finite Temperature Quantum Monte Carlo, FTQMC）}，\eqref{eq:ground-state-infty}对应的问题称为\concept{投影量子蒙特卡洛（Projector Quantum Monte Carlo, PQMC）}。
从\eqref{eq:quantum-expectation}和\eqref{eq:ground-state-infty}中可以看出，无论哪种量子蒙特卡洛，很大一部分工作是要计算$\ee^{-\beta \hat{H}}$，实际上就是计算虚时间路径积分。
我们将在\autoref{sec:worldline-mc}中显式地写出这个路径积分的表达式，但是它的用处不局限在\autoref{sec:worldline-mc}中。

\section{世界线蒙特卡洛方法}\label{sec:worldline-mc}

设哈密顿量可以被分解成
\begin{equation}
    \hat{H} = \hat{H}_1 + \hat{H}_2,
\end{equation}
其中$\hat{H}_1$和$\hat{H}_2$分别对应两个比较容易求解的问题。当然也可以把$\hat{H}$分解成更多哈密顿量之和，处理起来是类似的。
考虑到以下公式（\concept{Trotter-Suzuki近似}）：
\begin{equation}
    \left( \ee^{-\Delta \tau \hat{H}_1} \ee^{- \Delta \tau \hat{H}_2} \right)^m = \ee^{-\beta \hat{H}} + \frac{\Delta \tau}{2} \underbrace{\int_0^\beta \dd{\tau} \ee^{-(\beta-\tau) \hat{H}} \comm*{\hat{H}_1}{\hat{H}_2} \ee^{-\tau \hat{H}}}_{\hat{A}} + \bigO(\Delta \tau^2), \quad m \Delta \tau = \beta,
\end{equation}
我们有
\[
    \frac{\trace{(\hat{O} ( \ee^{-\Delta \tau \hat{H}_1} \ee^{- \Delta \tau \hat{H}_2} )^m)}}{\trace{(( \ee^{-\Delta \tau \hat{H}_1} \ee^{- \Delta \tau \hat{H}_2} )^m)}} = \frac{\trace(\hat{O} \ee^{-\beta \hat{H}}) + \frac{\Delta \tau}{2} \trace(\hat{O} \hat{A})}{\trace(\ee^{-\beta \hat{H}}) + \frac{\Delta \tau}{2} \trace\hat{A}} + \bigO(\Delta \tau^2),
\]
容易验证
\[
    \trace(\hat{A})^* = - \trace \hat{A}, \quad \trace(\hat{O} \hat{A})^* = - \trace(\hat{O} \hat{A}),
\]
于是如果
% TODO 误差分析
就能够有小到$\bigO(\Delta \tau^2)$的误差。
代入\eqref{eq:quantum-expectation}，就得到
\[
    \expval{O} = \frac{\trace{(\hat{O} ( \ee^{-\Delta \tau \hat{H}_1} \ee^{- \Delta \tau \hat{H}_2} )^m)}}{\trace{(( \ee^{-\Delta \tau \hat{H}_1} \ee^{- \Delta \tau \hat{H}_2} )^m)}}.
\]
使用标准的插入完备性条件的方法，并假定我们使用的表象是$\hat{O}$的本征态（由于$\hat{O}$的定义通常不会很复杂，它的本征态是可以计算出来的），那么
\[
    \trace{(( \ee^{-\Delta \tau \hat{H}_1} \ee^{- \Delta \tau \hat{H}_2} )^m)} = \sum_{n_1, n_2, \ldots, n_{2m}} \mel{n_1}{\ee^{-\Delta \tau \hat{H}_1}}{n_{2m}} \cdots \mel{n_3}{\ee^{-\Delta \tau \hat{H}_1}}{n_2} \mel{n_2}{\ee^{-\Delta \tau \hat{H}_2}}{n_1},
\]
而
\[
    \trace{(\hat{O} ( \ee^{-\Delta \tau \hat{H}_1} \ee^{- \Delta \tau \hat{H}_2} )^m)} = \sum_{n_1, n_2, \ldots, n_{2m}} \mel{n_1}{\ee^{-\Delta \tau \hat{H}_1}}{n_{2m}} \cdots \mel{n_3}{\ee^{-\Delta \tau \hat{H}_1}}{n_2} \mel{n_2}{\ee^{-\Delta \tau \hat{H}_2}}{n_1} O_{n_1},
\]
其中$O_{n_1}$指的是$\hat{O}$在本征态$\ket*{n_1}$上的本征值。
于是只要指定
\begin{equation}
    W(n_1) = \sum_{n_2, \ldots, n_{2m}} \mel{n_1}{\ee^{-\Delta \tau \hat{H}_1}}{n_{2m}} \cdots \mel{n_3}{\ee^{-\Delta \tau \hat{H}_1}}{n_2} \mel{n_2}{\ee^{-\Delta \tau \hat{H}_2}}{n_1},
    \label{eq:worldline-weight}
\end{equation}
套用\eqref{eq:classical-expectation}就计算出了$\expval{O}$。
\eqref{eq:worldline-weight}中的一系列矩阵元连乘实际上就是离散化的路径积分，一组这样的连乘对应着一条$\tau=i \Delta \tau$时状态为$\ket{n_i}$的虚时间世界线，因此这种方法称为\concept{世界线蒙特卡洛}。

% TODO:PQMC

比较糟糕的是，\eqref{eq:worldline-weight}中的诸矩阵元并不能够保证是正数，甚至不能够保证是实数，因此计算出来的路径积分权重\eqref{eq:worldline-weight}也不能够保证是正数甚至是实数。
因此，实际上我们并不能够得到一个真正的概率分布。
这可能导致蒙特卡洛算法不收敛，或者虽然收敛但由于分母非常小（正负抵消）而精度很差。
这就是所谓的\concept{符号问题}——$W(n)$的正负号不定导致模拟困难。

\section{辅助场蒙特卡洛方法}

\subsection{用辅助场代替系统状态}

\subsubsection{H-S变换引入辅助场}

为了解决世界线蒙特卡洛方法中的问题，我们尝试把路径积分转化成稍微容易计算一些的形式。
我们回顾固体物理中通常会出现什么样的问题。
一般来说哈密顿量可以写成自由哈密顿量加上相互作用哈密顿量。本节仅讨论相互作用哈密顿量为四次型（即只有二体相互作用，这是合理的，因为基本上固体理论中的相互作用几乎总是来自库伦相互作用）的情况，

虚时间路径积分实际上就是要计算一个$\ee$指数矩阵的迹。使用Trotter-Suzuki近似%
\footnote{为了和时间演化算符的通常写法保持一致，本文默认
\[
    \prod_{i=1}^n a_i = a_n a_{n-1} \cdots a_1.
\]
}%
，我们如下将虚时间路径积分写成自由部分和相互作用部分分离的形式：
\[
    \ee^{-\beta \hat{H}} = \prod_{n=1}^{m} \ee^{-\Delta \tau \hat{H}_0} \ee^{-\Delta \tau \hat{H}_\text{I}}.
\]
这里用到了Trotter-Suzuki近似，这个近似的误差控制在$\Delta \tau^2$量级。% TODO
如果哈密顿量是自由的，也就是说，能够写成
\[
    \hat{H} = \hat{H}_0 = \sum_{i, j} \hat{c}_i^\dagger A_{ij} \hat{c}_j
\]
的形式，那么这就比较容易，因为
\begin{equation}
    \trace(\ee^{- \sum_{i, j} \hat{c}_i^\dagger A_{ij} \hat{c}_j}) = \det(1 + \ee^{- \vb{A}}).
\end{equation}
很容易通过对角化验证上式。实际上，更加一般的，我们有
\begin{equation}
    \trace(\ee^{- \sum_{i, j} \hat{c}_i^\dagger A_{ij} \hat{c}_j} \ee^{- \sum_{i, j} \hat{c}_i^\dagger B_{ij} \hat{c}_j} \cdots) = \det(1 + \ee^{- \vb{A}}\ee^{- \vb{B}_{\vb{s}}} \cdots),
    \label{eq:trace-to-det}
\end{equation}
甚至更一般的情况。
总之，自由费米子哈密顿量的路径积分可以很容易地将费米子算符积掉，留下一个（可以使用标准的线性代数方法计算的）行列式。

实际的哈密顿量为
\[
    \hat{H} = \hat{H}_0 + \hat{H}_\text{I}, 
\]
我们就需要设法将$\hat{H}_\text{I}$转化为单粒子算符的形式，也就是说要引入一个辅助场，让费米子之间的相互作用等效为费米子和这个辅助场的相互作用。
由于我们只讨论二费米子过程\eqref{eq:two-fermions-hamiltonian}，可以使用离散H-S变换引入这个辅助场，然后积掉费米子自由度而剩下辅助场自由度。辅助场自由度是一整个辅助场世界线，也就是说如果有$d$个空间维度，那么辅助场世界线就有$d+1$个维度。
这是量子统计的普遍特征：$d$维的量子系统等价于$d+1$维的经典系统，多出来的一个维度是（有限大小的）虚时间。最后就使用关于一系列辅助场构型的行列式之和写出了虚时间路径积分。

\subsubsection{虚时间路径积分的行列式表示}

接下来我们引入一些简便记号。设$\hat{c}^\dagger$表示适当表象下的费米子产生算符排成的行向量，$\vb{s}_n$和$\vb{s}_\tau$表示第$n$个虚时间采样点（也即，$\tau=n\Delta \tau$）处的辅助场构型，如无特殊说明$\vb{s}$就表示整个辅助场时间线，并将虚时间路径积分写成
\begin{equation}
    \ee^{-\beta \hat{H}} = \sum_{\vb{s}} C(\vb{s}) \prod_{n=1}^m \ee^{-\Delta \tau \hat{H}_0} \ee^{-H_\text{I}(\vb{s}_n)}, 
    \label{eq:imaginary-time-path-integral-with-aux-field}
\end{equation}
应注意其中$H_\text{I}(\vb{s}_n)$和之前定义的$\hat{H}_\text{I}$未必相等，它现在是积掉了费米子自由度之后的哈密顿量。
由于$\hat{H}_0$是二次型，而由H-S变换的性质，$\hat{H}_\text{I}$也是二次型，则可以设
\begin{equation}
    \hat{H}_0 = \hat{c}^\dagger \vb{h}_0 \hat{c}, \quad \hat{H}_\text{I} = \hat{c}^\dagger \vb{h}_\text{I} \hat{c},
\end{equation}
其中$\vb{h}_\text{I}$和$\vb{h}_0$是系数矩阵。
为了简写我们显式地引入虚时间演化算符（由于虚时间演化算符含有全部动力学，我们这里采取的是虚时间的薛定谔绘景：不需要考虑算符的变动）
\begin{equation}
    \hat{U}_{\vb{s}}(\tau_2, \tau_1) = \prod_{n=n_1+1}^{n_2} \ee^{-\Delta \tau \hat{H}_0} \ee^{- \hat{H}_\text{I}(\vb{s}_n)}, \quad \vb{B}_{\vb{s}}(\tau_2, \tau_1) = \prod_{n=n_1+1}^{n_2} \ee^{-\Delta \tau \vb{h}_0} \ee^{-\vb{h}_\text{I}(\vb{s}_n)},
\end{equation}
使用这些记号并考虑到\eqref{eq:imaginary-time-path-integral-with-aux-field}，
\[
    \trace(\ee^{-\beta \hat{H}}) = \sum_{\vb{s}} C(\vb{s}) \trace \hat{U}_{\vb{s}}(\beta, 0) = \sum_{\vb{s}} C(\vb{s}) \det(1 + \vb{B}_{\vb{s}}(\beta, 0)),
\]
而
\[
    \begin{aligned}
        \trace(\ee^{-\beta \hat{H}} \hat{O}) &= \sum_{\vb{s}} C(\vb{s}) \trace(\hat{O} \ee^{-\beta \hat{H}}) \\
        &= \sum_{\vb{s}} C(\vb{s}) \trace\hat{U}_{\vb{s}}(\beta, 0) \frac{\trace(\hat{O} \hat{U}_{\vb{s}}(\beta, 0))}{\trace \hat{U}_{\vb{s}}(\beta, 0)},
    \end{aligned} 
\]
于是我们就得到
\begin{equation}
    \expval*{\hat{O}} = \sum_{\vb{s}} C(\vb{s}) \det(1 + \vb{B}_{\vb{s}}(\beta, 0)) \frac{\trace(\hat{O} \hat{U}_{\vb{s}}(\beta, 0))}{\trace \hat{U}_{\vb{s}}(\beta, 0)}.
\end{equation}
为了略微增大一般性，例如，为了计算响应函数之类的东西，我们引入完整的虚时间轴上各点的期望值：
\begin{equation}
    \expval*{\hat{O}}(\tau) = \frac{\trace(\hat{U}_{\vb{s}}(\beta, \tau) \hat{O} \hat{U}_{\vb{s}}(\tau, 0))}{\trace \hat{U}_{\vb{s}}(\beta, 0)}.
\end{equation}

\subsubsection{物理量的期望}

原则上，我们可以直接使用以上方法现在构造一个经典的随机现象，使得
\begin{equation}
    p(\vb{s}) = \frac{ C(\vb{s}) \det(1 + \vb{B}_{\vb{s}}(\beta, 0))}{\sum_{\vb{s}} C(\vb{s}) \det(1 + \vb{B}_{\vb{s}}(\beta, 0))}, \quad \expval{O}_{\vb{s}} = \frac{\trace(\hat{O} \hat{U}_{\vb{s}}(\beta, 0))}{\trace \hat{U}_{\vb{s}}(\beta, 0)},
\end{equation}
并且使用标准的有限温度平衡态场论的方法，也就是
\begin{equation}
    \expval{O}_{\vb{s}} = \eval{\pdv{\ln \trace(\ee^{\eta \hat{O}} \hat{U}_{\vb{s}}(\beta, 0))}{\eta}}_{\eta=0},
\end{equation}
计算出$\expval{O}_{\vb{s}}$（由于此时费米子相互作用已经积掉了，而$\vb{s}$又固定死了，仅有的自由度就是费米子自由度，而且只有二次型是，则Wick定理适用），我们就可以使用\eqref{eq:classical-expectation}得到各种物理量的期望值了。

例如在$\hat{O}$是单体算符时，设
\begin{equation}
    \hat{O} = \hat{c}^\dagger \vb{A} \hat{c},
\end{equation}
则容易看出
\begin{equation}
    \expval{O}_{\vb{s}}(t) = \trace((1 - (1+ \vb{B}_{\vb{s}}(\tau, 0) \vb{B}_{\vb{s}}(\beta, \tau))^{-1}) \vb{A}).
\end{equation}
相应的，格点坐标表象下的等时格林函数就是
\begin{equation}
    \expval*{\hat{c}_x(\tau) \hat{c}^\dagger_y(\tau)}_{\vb{s}} = (1+ \vb{B}_{\vb{s}}(\tau, 0) \vb{B}_{\vb{s}}(\beta, \tau))^{-1}_{xy},
\end{equation}
相应的记其系数矩阵为$\vb{G}(\tau, \tau)$，则有
\begin{equation}
    \vb{G} = (1+ \vb{B}_{\vb{s}}(\tau, 0) \vb{B}_{\vb{s}}(\beta, \tau))^{-1}.
\end{equation}
需要说明的是这里其实没有用到任何关于标签$x, y$的特殊性质——它们可以是$(i, \sigma)$，即格点坐标和自旋的组合，或者，如果能够保证自旋旋转不变性，那么不同的自旋实际上是解耦的，则可以取$x, y$为格点坐标，而单独附加标注自旋。

多体算符可以使用格林函数算出来。

\subsubsection{更新}

\subsection{Hubbard型相互作用}

\subsubsection{H-S变换}

考虑如下相互作用：
\begin{equation}
    \hat{H}_\text{I} = U \sum_i (\hat{n}_{i, \uparrow} - \frac{1}{2}) (\hat{n}_{i, \downarrow} - \frac{1}{2}),
\end{equation}
我们特意在标准的Hubbard相互作用的粒子数中减去了$1/2$，不过这无关紧要，无非是改变了化学势的零点而已。

\subsection{完全平方型相互作用哈密顿量}

\subsubsection{H-S变换}

设我们有
\begin{equation}
    \hat{H}_\text{I} = - W \sum_{i} \left( \hat{O}^{(i)} \right)^2.
    \label{eq:two-fermions-hamiltonian}
\end{equation}
这里我们假定已经将$\hat{H}_\text{I}$做了对角化，即在单粒子表象$\{\ket*{i}\}$（具体它是什么，和$\hat{H}_\text{I}$的形式有关，比如很多时候是动量，也可能就是格点坐标，等等）下将它分解成一系列单粒子可观察量的平方之和。

我们以“每个格点上的粒子状态”为表象，那么系统哈密顿量可以写成矩阵形式，至少原则上\eqref{eq:quantum-expectation}是可以用的。
和\autoref{sec:worldline-mc}中一样，我们做$\ee$指数的离散化，使用$n$标记离散的虚时间，使用$i$表示\eqref{eq:two-fermions-hamiltonian}中标记相互作用部分中单粒子算符的量子数。
我们使用离散H-S变换
\begin{equation}
    \ee^{\Delta \tau W O^2} = \sum_{l = \pm 1, \pm 2} \gamma(l) \ee^{\sqrt{\Delta \tau W} \eta(l) O} + \bigO(\Delta \tau^3),
\end{equation}
其中
\begin{equation}
    \begin{aligned}
        \eta(\pm 1) &= \pm \sqrt{2(3-\sqrt{6})}, \quad \eta(\pm 2) = \pm \sqrt{2(3+\sqrt{6})}, \\
        \gamma(\pm 1) &= 1 + \sqrt{6}/3, \quad \gamma(\pm 2) = 1 - \sqrt{6}/3.
    \end{aligned}
\end{equation}
引入$l$为辅助场，用$l_i$表示对$\ee^{\Delta \tau W (\hat{O}^{(i)})^2}$做H-S变换二引入的那个$l$，这样，$\{l_i\}$在每个$i$上都可以取$\pm 1, \pm 2$的值。
这样我们就有
\[
    \begin{aligned}
        \ee^{-\beta \hat{H}} &= \prod_{n=1}^m \ee^{-\Delta \tau \hat{H}_0} \prod_{i=1}^N \sum_{l_i = \pm 1, \pm 2} \gamma(l_i) \ee^{\sqrt{\Delta \tau W} \eta(l_i) O^{(i)}} \\
        &= \prod_{n=1}^m \ee^{-\Delta \tau \hat{H}_0} \sum_{\{l_i\}} \prod_{i=1}^N \gamma(l_i) \ee^{\sqrt{\Delta \tau W} \eta(l_i) O^{(i)}} \\
        &= \sum_{{l_{i, n}}} \prod_{n=1}^m \ee^{-\Delta \tau \hat{H}_0} \prod_{i=1}^N \gamma(l_i) \ee^{\sqrt{\Delta \tau W} \eta(l_i) O^{(i)}}.
    \end{aligned}
\]
其中$\{l_{i,n}\}$指的是将$n$个任意的$\{l_i\}$放在一起而得到的列表，实际上就是离散的辅助场$\{l_i\}$的虚时间世界线——这是正确的，我们当然应该得到辅助场的虚时间世界线。
总之，我们得到了
\begin{equation}
    \ee^{-\beta \hat{H}} = \sum_{{l_{i, n}}} \underbrace{\prod_{n=1}^m \ee^{-\Delta \tau \hat{H}_0} \prod_{i=1}^N \gamma(l_i) \ee^{\sqrt{\Delta \tau W} \eta(l_i) O^{(i)}}}_{\sim \ee^{-\beta \sum_n \hat{H}_\text{eff}}},
    \label{eq:imaginary-time-path-integral}
\end{equation}
请注意上式所有$\ee$指数中的算符都是二次型，因此可以套用\eqref{eq:trace-to-det}。

\subsubsection{物理量期望值}

接下来我们引入一些简便记号。设$\hat{c}^\dagger$表示适当表象下的费米子产生算符排成的行向量，$\vb{s}_n$和$\vb{s}_\tau$表示第$n$个虚时间采样点（也即，$\tau=n\Delta \tau$）处的辅助场构型，如无特殊说明$\vb{s}$就表示整个辅助场时间线，并将\eqref{eq:imaginary-time-path-integral}写成
\begin{equation}
    \ee^{-\beta \hat{H}} = \sum_{\vb{s}} C(\vb{s}) \prod_{n=1}^m \ee^{-\Delta \tau \hat{H}_0} \ee^{-H_\text{I}(\vb{s}_n)}, \quad C(\vb{s}) \ee^{-H_\text{I}(\vb{s}_n)} = \prod_{i=1}^N \gamma(l_i) \ee^{\sqrt{\Delta \tau W} \eta(l_i) O^{(i)}},
    \label{eq:o2-path-integral}
\end{equation}
应注意其中$H_\text{I}(\vb{s}_n)$和之前定义的$\hat{H}_\text{I}$未必相等。
由于$\hat{H}_0$是二次型，而由H-S变换的性质，$\hat{H}_\text{I}$也是二次型，则可以设
\begin{equation}
    \hat{H}_0 = \hat{c}^\dagger \vb{h}_0 \hat{c}, \quad \hat{H}_\text{I} = \hat{c}^\dagger \vb{h}_\text{I} \hat{c},
\end{equation}
其中$\vb{h}_\text{I}$和$\vb{h}_0$是系数矩阵。
为了简写我们引入记号
\begin{equation}
    \hat{U}(\tau_2, \tau_1) = \prod_{n=n_1+1}^{n_2} \ee^{-\Delta \tau \hat{H}_0} \ee^{- \hat{H}_\text{I}(\vb{s}_n)}, \quad \vb{B}_{\vb{s}}(\tau_2, \tau_1) = \prod_{n=n_1+1}^{n_2} \ee^{-\Delta \tau \vb{h}_0} \ee^{-\vb{h}_\text{I}(\vb{s}_n)},
\end{equation}
使用这些记号并考虑到\eqref{eq:imaginary-time-path-integral-with-aux-field}，
\[
    \trace(\ee^{-\beta \hat{H}}) = \sum_{\vb{s}} C(\vb{s}) \trace \hat{U}(\beta, 0) = \sum_{\vb{s}} C(\vb{s}) \det(1 + \vb{B}_{\vb{s}}(\beta, 0)),
\]
而
\[
    \begin{aligned}
        \trace(\ee^{-\beta \hat{H}} \hat{O}) &= \sum_{\vb{s}} C(\vb{s}) \trace(\hat{O} \ee^{-\beta \hat{H}}) \\
        &= \sum_{\vb{s}} C(\vb{s}) \trace\hat{U}(\beta, 0) \frac{\trace(\hat{O} \hat{U}(\beta, 0))}{\trace \hat{U}(\beta, 0)} \\
        &= \sum_{\vb{s}} C(\vb{s}) \det(1 + \vb{B}_{\vb{s}}(\beta, 0)) \frac{\trace(\hat{O} \hat{U}(\beta, 0))}{\trace \hat{U}(\beta, 0)}.
    \end{aligned} 
\]
现在构造一个经典的随机现象，使得
\begin{equation}
    p(\vb{s}) = \frac{ C(\vb{s}) \det(1 + \vb{B}_{\vb{s}}(\beta, 0))}{\sum_{\vb{s}} C(\vb{s}) \det(1 + \vb{B}_{\vb{s}}(\beta, 0))}, \quad \expval{O}_{\vb{s}} = \frac{\trace(\hat{O} \hat{U}(\beta, 0))}{\trace \hat{U}(\beta, 0)},
\end{equation}
并且使用标准的有限温度平衡态场论的方法计算出$\expval{O}_{\vb{s}}$（由于是自由场论，Wick定理适用），我们就可以使用\eqref{eq:classical-expectation}得到各种物理量的期望值了。

使用生成泛函，有
\begin{equation}
    \expval{O}_{\vb{s}} = \eval{\pdv{\ln \trace(\ee^{\eta \hat{O}} \hat{U}(\beta, 0))}{\eta}}_{\eta=0},
\end{equation}
在$\hat{O}$是单体算符时，设
\begin{equation}
    \hat{O} = \hat{c}^\dagger \vb{A} \hat{c},
\end{equation}
则容易看出
\begin{equation}
    \expval{O}_{\vb{s}} = \trace((1 - (1+\vb{B}_{\vb{s}}(\beta, 0))^{-1}) \vb{A}).
\end{equation}

% TODO：怎么计算二体物理量？

\end{document}