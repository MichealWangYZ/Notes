\documentclass[hyperref, UTF8, a4paper]{ctexart}

\usepackage{geometry}
\usepackage{titling}
\usepackage{titlesec}
\usepackage{paralist}
\usepackage{footnote}
\usepackage{enumerate}
\usepackage{amsmath, amssymb, amsthm}
\usepackage{cite}
\usepackage{graphicx}
\usepackage{subfigure}
\usepackage{physics}
\usepackage{tikz}
\usepackage[colorlinks, linkcolor=black, anchorcolor=black, citecolor=black]{hyperref}
\usepackage{prettyref}

\geometry{left=3.18cm,right=3.18cm,top=2.54cm,bottom=2.54cm}
\titlespacing{\paragraph}{0pt}{1pt}{10pt}[20pt]
\setlength{\droptitle}{-5em}
\preauthor{\vspace{-10pt}\begin{center}}
\postauthor{\par\end{center}}

\DeclareMathOperator{\timeorder}{T}
\DeclareMathOperator{\diag}{diag}
\DeclareMathOperator{\res}{Res}
\DeclareMathOperator{\primevalue}{P}
\newcommand*{\ii}{\mathrm{i}}
\newcommand*{\ee}{\mathrm{e}}
\newcommand*{\const}{\mathrm{const}}
\newcommand*{\comment}{\paragraph{注记}}

\newrefformat{sec}{第\ref{#1}节}
\newrefformat{note}{注\ref{#1}}
\renewcommand{\autoref}{\prettyref}

\newenvironment{bigcase}{\left\{\quad\begin{aligned}}{\end{aligned}\right.}

\title{统计物理}
\author{wujinq}

\begin{document}

\maketitle

% TODO：基态是不是一定是温度为零的态？？

\section{量子统计理论}

我们将讨论量子系统的统计力学。本文中我们将采用标准的关于“测量”的理论而不分析其背后的原理。
使用$\{\ket{n}\}$表示系统态空间的一组完备正交基。
有物理意义的哈密顿量都有基态，因此我们可以通过移动能量零点的方法，让哈密顿量的各个本征值都大于零。

使用$\expval*{\hat{A}}$或者$\bar{A}$来表示可观察量$\hat{A}$的期望值。
使用$T$表示编时算符，$\Theta(t)$表示阶跃函数。

\subsection{混合态和密度算符}

\subsubsection{引入密度算符}\label{sec:introduction-of-density-operator}

很多量子系统——即使简单如一个单粒子——的态空间都可以分解成一些态空间的直积。
一些时候我们只是关心整个系统的一部分。因此，接下来称我们关心的这部分为\textbf{系统}，称我们不关心的部分为\textbf{环境}。
我们设环境完全被算符$\hat{B}$描述而$\hat{A}$是关于系统的一个算符，则系统-环境对的态可以写成这样：
\begin{equation}
    \ket{\text{sys-env}} = \sum_i c_i \ket{\psi_i} \ket{B_i}.
    \label{eq:sys-env-state}
\end{equation}
也就是说我们把系统-环境对的态中含有的所有项都整理成以上形式。
我们还假定系统的演化独立于环境，
这或者是因为环境对系统的作用并不强以至于可以忽略，或者是因为环境对系统的作用如此之强以至于其结果可以很容易地知道而不需要考虑环境的内部状态（例如，考虑原子核对电子的作用）。
然而，虽然系统和环境之间没有耦合，但在制备系统的时候\eqref{eq:sys-env-state}中的$\ket{\psi_i}$和$\ket{B_i}$之间有某种关系，
例如，如果通过裂变的方式制备具有某种自旋的粒子束，那么我们需要的粒子和我们丢弃的粒子放在一起的态就是%
\footnote{可以看到，产生纠缠态还是需要系统和环境发生相互作用。如果系统和环境在$t=-\infty$时就没有发生相互作用，并且它们的动力学彼此不相关，那么它们的态就永远不会有纠缠。但纠缠态产生之后，就算系统和环境不再发生相互作用，纠缠还是会一直存在。\label{note:entangled-states}}
\[
    \ket{\text{all}} = \frac{1}{\sqrt{2}} \ket{\uparrow} \ket{\uparrow} + \frac{1}{\sqrt{2}} \ket{\downarrow} \ket{\downarrow},
\]
两个粒子一旦被制备就不再有相互作用，但是显然不可能使用$\ket{\uparrow}$和$\ket{\downarrow}$的叠加写出其中任何一个粒子的态——不能够写出
\[
    \ket{\text{all}} = \left( a_1 \ket{\uparrow} + b_1 \ket{\downarrow} \right) \otimes \left( a_2 \ket{\uparrow} + b_2 \ket{\downarrow} \right)
\]
这样的表达式。
把第一个粒子看成系统而第二个粒子看成环境的一部分我们就得到了\eqref{eq:sys-env-state}形式的态。这种“总系统的态不能够写成各个部分的态的直积”情况称为\textbf{量子纠缠}。
这意味着，系统的观察结果不可能完全由诸$\ket{\psi_i}$确定，而必须考虑环境；但是通常环境是什么样的我们并不知道。
因此不能够简单地通过“求解系统-环境对的运动方程”来计算我们关心的结果，而必须通过某种手段把环境“积掉”。
具体怎么做，接下来很快会看到。

可以制备大量的这种系统-环境对，这些系统-环境对之间并没有相互作用，它们的集合称为\textbf{系综}。
系综很自然地导致一个使用古典概型的\textbf{概率}。
通过系综计算出来的概率和真的动手做变量控制得足够好的实验时的概率是一致的：动手做实验时实验结果依赖于某些环境参数$\theta$，
只要环境是足够杂乱，以至于$\theta$的分布完全随机（环境通常足够大，因此总是这样），
那么重复做实验就是采集了大量$\theta$样本，每个$\theta$确定了一个系统，从而建立了一个系综。%
\footnote{当然，系综中系统-环境对的数目总是很大的，而真实的实验做不了那么多次。这里只是原理性地说明系综这一概念的合理性。}%
% TODO：以上说法和退相干等的关系
% 还有这其实有点循环论证的意味：多次实验做出来的概率和系综算出来的概率一致是因为环境提供了很好的随机数，
% 环境为什么能够提供经典意义上的随机数要严格论证还是要用到系综的概念。
% 当然如果假定了多重宇宙那就没有任何问题了——这样我们有了一个“原始系综”，因此可以严格地定义“某个事件发生的概率”：
% 它就是这个事件发生的宇宙的数目除以宇宙总数目。
另一种会自然地要求我们讨论系综的情景是，系统的初态依赖某些参数，而我们并不知道这些参数是什么，于是不得不列出所有可能的参数然后平行地让这些可能的态往前演化，看看具有不同性质的态各占多少。
很容易看出这和“多次做实验”根本就是一回事。

现在我们从这个系综当中随机取出一个系统-环境对，然后对它做一次测量，会得到什么样的结果？
算符$\hat{A}$在系统的态空间和环境的态空间的直积上显然是简并的（无论$\hat{A}$在系统的态空间上是不是简并的）。
测量态\eqref{eq:sys-env-state}的$\hat{A}$值。设$\hat{A}$的本征值$A_i$对应着系统的本征态$\ket{A_i^{(j)}}$，$j=1, 2, \ldots$。
测量结果为$A_i$的概率是
\[
    \begin{aligned}
        P(A_i) &= \sum_{j,k} \abs{\bra{A_i^{(j)}} \bra{B_k} \ket{\text{sys-env}}}^2 \\
        &= \sum_{j, k} \abs{ \bra{A_i^{(j)}} \sum_l c_l \ket{\psi_l} \braket{B_k}{B_l} }^2 \\
        &= \sum_{j, k} \abs{c_k}^2 \abs{\braket{A_i^{(j)}}{{\psi_k}}}^2 \\
        &= \sum_j \ev{ \sum_k \abs{c_k}^2 \dyad{\psi_k} }{A_i^{(j)}}
    \end{aligned}
\]
从系综中随机抽取一个系统-环境对，用$\hat{A}$做测量，得到结果为$A_i$的概率是：
\[
    \begin{aligned}
        P(A_i) &= \sum_j P(\ket{\text{sys-env}_j}) P(\text{$\ket{\text{sys-env}_j}$ gives $A_i$}) \\
        &= \sum_l P(\ket{\text{sys-env}_l}) \sum_j \ev{ \sum_k \abs{c_{l, k}}^2 \dyad{\psi_{l, k}} }{A_i^{(j)}} \\
        &= \sum_j \ev{ \sum_{l, k} P(\ket{\text{sys-env}_l}) \abs{c_{l, k}}^2 \dyad{\psi_{l, k}} }{A_i^{(j)}},
    \end{aligned}
\]
其中下标$l, k$指的是系综中第$l$个系统的第$k$个$\ket{\psi}$（见\eqref{eq:sys-env-state}）。
我们定义\textbf{密度算符}
\begin{equation}
    \hat{\rho} = \sum_{l, k} P(\ket{\text{sys-env}_l}) \abs{c_{l, k}}^2 \dyad{\psi_{l, k}},
    \label{eq:density-operator-def}
\end{equation}
就有
\begin{equation}
    P(A_i) = \sum_j \ev{\hat{\rho}}{A_i^{(j)}}.
    \label{eq:prop-of-quantity}
\end{equation}
相应的，期望值为
\[
    \expval*{\hat{A}} = \sum_{i, j} A_i \ev{\hat{\rho}}{A_i^{(j)}}.
\]
注意到
\[
    \sum_{i, j} \ev{\hat{\rho} A_i }{A_i^{(j)}} = \sum_{i, j} \ev{\hat{\rho} \hat{A} }{A_i^{(j)}} = \trace \left(\hat{\rho} \hat{A}\right),
\]
我们得到
\begin{equation}
    \expval*{\hat{A}} = \sum_{i, j} A_i \ev{\hat{\rho}}{A_i^{(j)}} = \trace \left(\hat{\rho} \hat{A}\right).
    \label{eq:expectation}
\end{equation}

在\eqref{eq:density-operator-def}中$\abs{c_{l, k}}^2$相当于是$P(\ket{\psi_{l, k}}|\ket{\text{sys-env}_l})$（归一化性质是显然的），
于是\eqref{eq:density-operator-def}写成%
\footnote{由于量子态的平方才是概率，如果我们认为量子态本身是某种概率性理论中的对象，我们就必须要区分经典概率和量子概率：前者是从一个系综中取出一个系统，这个系统具有某些性质的可能性，后者则是这个系统的可观察量取不同值的概率。
但正如此处我们看到的那样，实际上两者可以以统一的方式处理，我们完全可以良定义一个$P(\ket{psi_i})$。
如果回顾测量的意义，我们会发现所谓测量无非就是系统与环境相互作用，导致系统和环境出现纠缠，而具体得到什么结果和我们未知——因此只能够使用一个概率分布来模拟的——环境变量有关，可见量子态本身和概率毫无关系，量子力学中的概率的概念完全是因为做测量时对环境的无知导致的，而使用概率分布来穷举所有可能的环境变量的方式和我们穷举所有可能出现的系统状态构造一个系综（从而引入所谓“经典概率”）的方式完全一样。
因此，根本就没有所谓经典概率和量子概率的区分：量子力学中的概率和构造统计系综时引入的概率具有同样的起源。}%
\begin{equation}
    \hat{\rho} = \sum_{i} P(\ket{\psi_i}) \dyad{\psi_i},
    \label{eq:density-operator}
\end{equation}
其中$P(\ket{\psi_i})$指的是从系综中随机取出一个态，经过测量发现它处于$\ket{\psi_i}$的概率。%
\footnote{更准确地说，这是“经过测量之后发现它在各个$\ket{\psi}$态之中处于$\ket{\psi_i}$”的概率。
测量永远是针对一个算符的而不是针对一个单独的态的，对系统做一次测量，观察它会落到诸$\ket{\psi}$中的哪一个的方法是，构造算符
\[
    \hat{A} = \sum_i A_i \dyad{\psi_i},
\]
其中不同的$i$对应不同的$A_i$，然后使用这个算符对系统做测量，若测量结果是某个$A_i$，那么系统就落在了态$\ket{\psi_i}$上。单独把态$\ket{\psi_i}$拿出来讨论“它出现的概率”是和量子力学的框架相矛盾的。不过，为了说明方便，在各个$\ket{\psi}$态给定的情况下，我们常用“系统取$\ket{\psi_i}$的概率这样的说法”。}%
需要注意的是，即使诸$\ket{\psi_i}$相互并不正交，\eqref{eq:density-operator}也是成立的。
\eqref{eq:density-operator}中的每一项的系数都是正的，因此$\hat{\rho}$是正定的。
而又由于\eqref{eq:density-operator}中每一项的系数都小于等于$1$，数学上可以证明，$\hat{\rho}$的本征值全部在$0$和$1$之间，可以取到$1$。
当然，如果\eqref{eq:density-operator}中的某一个$P(\ket{\psi_i})$真的取到了$1$，那么按照概率的性质，此时其余的$P(\ket{\psi_j})$都是零，从而
\[
    \hat{\rho} = \dyad{\psi_i},
\]
因此系统处于纯态。类似地也可以说明，$\hat{\rho}$的本征值取到$1$，当且仅当系统处于纯态；此时$\hat{\rho}$的本征态就是系统的态矢量。

如果可能的$\psi_i$只有一个，那么称此时的系综是\textbf{纯}的，或者说系统处于纯态，因为此时根本不需要引入系综的概念：直接对这个仅有的$\ket{\psi}$解运动方程就可以得到想要的一切信息。
否则，称此时的系综为\textbf{混合}的，或者说系统处于混合态。
需要注意的是即使是纯态也会引入随机性，因为测量所用的算符的本征态未必和$\ket{\psi_i}$一致。
但混合态引入了另一种随机性：我们甚至不知道系统（从系综中随便选取的某一个）具体处于什么态！
这种随机性是由于我们缺乏某些信息而产生的：我们或者不知道和我们关心的系统纠缠的态是什么样的，或者不知道我们关心的系统到底在什么态上面。

通常，对一个系综我们只关心特定的物理量取某些值的概率，以及物理量的期望，后者又可以从前者推出来。
从\eqref{eq:prop-of-quantity}和\eqref{eq:expectation}可以看出，密度算符给出了所有这些信息。
因此我们认为密度算符完整描述了系综。
除了这两项信息以外的信息则不能从密度算符中提取。例如，请注意从\eqref{eq:density-operator}中不能读取出$\ket{\psi_i}$分别都是什么，因为可以找到多组$\ket{\psi_i}$，使用不同的$P$，而得到同样的$\hat{\rho}$，也就是说不同构造的系综可以有同样的密度算符。
通常称诸$\ket{\psi_i}$，也就是有非零系数的态，为\textbf{参与态}。显然密度算符提供不了参与态具体是什么的信息，不过一般我们也不需要这些信息。
实际上，\eqref{eq:density-operator}本身就体现了这一点：我们并不关心混合态是因为系统和环境的纠缠还是因为别的什么引起的，因此使用统一的\eqref{eq:density-operator}处理两种情况。

一般来说，对实际的、通常规模很大的系统，我们不可能知道它的所有信息。或者我们不知道它的某些参数，或者我们不知道它是不是和环境纠缠在一起。无论哪种情况，描述系统都需要使用混合态。
因此接下来在不至于引起混淆时我们不严格区分“系统”和“系综”，因为我们根本就不知道“实际上的系统”是什么样子的，而只能讨论系综。于是称纯的系综处于\textbf{纯态}，混合系综处于\textbf{混合态}。
相应的，凡是不能够从密度算符中读取得到的信息，我们一概不讨论，因为这些信息不能从系综中读出来。

\subsubsection{时间演化}

下面我们分析密度算符的时间演化。我们将只讨论不显含时间的物理量。为了一般性，首先在相互作用绘景下分析问题。此时
\[
    \ii \hbar \dv{t} \ket{\psi^I} = \hat{H}_i^I \ket{\psi^I},
\]
由于系统和环境的演化可认为是彼此独立的，于是系统-环境的时间演化算符是系统的时间演化算符和环境的时间演化算符的直积，两者均为幺正算符，从而随着时间演化，$c_i$不会变化。
另一方面，如果两个态在某一个时刻不同，那么它们不会在某一个连续的时间区间内处处相同；
既然$P(\ket{\text{sys-env}_l})$是通过系综中相同的态的个数除以总个数算出来的，显然我们有
\[
    P_{t_1} (\ket{\text{sys-env}_l (t_1)}) = P_{t_2} (\ket{\text{sys-env}_l (t_2)}).
\]
于是以下我们略去$P$的时间下标以及其括号内的时间标记，因为这个参数对$P$而言没有意义。
因此$P(\ket{\psi_i})$恒定不变。
这样可以推导出
\begin{equation}
    \dv{\hat{\rho}^I}{t} = \frac{1}{\ii \hbar} \comm*{\hat{H}_i^I}{\hat{\rho}^I}.
\end{equation}
请注意这个方程的对易子和算符运动方程的对易子是反的。
由此，我们顺带得出了薛定谔绘景中的密度算符演化方程
\begin{equation}
    \dv{\hat{\rho}^S}{t} = \frac{1}{\ii \hbar} \comm*{\hat{H}^S}{\hat{\rho}^S},
\end{equation}
以及海森堡绘景中的密度算符演化方程
\begin{equation}
    \hat{\rho}^H = \const.
\end{equation}
请注意这些方程在$\hbar \to 0$时退化为经典统计力学中的刘维尔方程，因此称其为\textbf{量子刘维尔方程}。

为方便起见，我们将薛定谔绘景和相互作用绘景之间的关系罗列如下：
做哈密顿量的分解
\begin{equation}
    \hat{H}^S = \hat{H}_0 + \hat{H}_i^S,
\end{equation}
则
\begin{equation}
    \ket{\psi^I(t)} = \hat{U}_0^\dagger(t,t_0) \ket{\psi^S(t)},
\end{equation}
从而密度算符的切换关系为
\begin{equation}
    \hat{\rho}^I = \hat{U}_0^\dagger(t,t_0) \hat{\rho}^S \hat{U}_0(t,t_0),
\end{equation}
可观察量的切换关系为
\begin{equation}
    \hat{A}^I = \hat{U}_0^\dagger(t,t_0) \hat{A}^S \hat{U}_0(t,t_0),
\end{equation}
其中
\begin{equation}
    \hat{U}_0 = T \exp \left( - \frac{\ii}{\hbar} \int_{t_0}^t \dd{t} \hat{H}_0 \right),
\end{equation}
当$\hat{H}_0$不含时时就是简单的
\begin{equation}
    \hat{U}_0 = \ee^{-\frac{\ii}{\hbar} (t-t_0) \hat{H}_0}.
\end{equation}

系综达到平衡，也就是说，各个物理量出现的概率都不再发生任何变化的时候，意味着密度算符不变，这又等价于
\begin{equation}
    [\hat{\rho}, \hat{H}] = 0.
    \label{eq:equilibrium-case}
\end{equation}
这个方程的成立不依赖于绘景。

\subsubsection{密度算符的性质}

现在来分析密度算符的性质。为方便起见以下记
\[
    P(\ket{\psi_i}) = p_i.
\]
首先，
\[
    \trace \hat{\rho} = \sum_n \mel{n}{\hat{\rho}}{n} = \sum_n \mel{n}{\sum_i p_i \dyad{\psi_i}}{n} = \sum_{n, i} p_i \braket{n}{\psi_i} \braket{\psi_i}{n},
\]
于是
\begin{equation}
    \trace \hat{\rho} = 1.
    \label{eq:trace-of-density-operator}
\end{equation}
容易看出导出\eqref{eq:trace-of-density-operator}的论证也可以反过来用。在已知\eqref{eq:trace-of-density-operator}的情况下，可以推知，若$\hat{\rho}$可以被展开为一系列归一化态的叠加
\[
    \hat{\rho} = \sum_i \rho_i \dyad{\psi_i},
\]
则
\[
    \sum_i \rho_i = 1,
\]
无论诸$\ket{\psi_i}$是否正交。通常称$\rho_i$为\textbf{分布函数}。

\eqref{eq:trace-of-density-operator}无论是对纯态还是混合态都是成立的。
然而，$\hat{\rho}^2$的迹却并非如此。对纯态而言
\[
    \hat{\rho}^2 = \dyad{\psi} \dyad{\psi} = \dyad{\psi} = \hat{\rho},
\]
而对混合态，
\[
    \hat{\rho}^2 = \sum_{i, j} p_i p_j \braket{\psi_i}{\psi_j} \dyad{\psi_i}{\psi_j},
\]
从而
\[
    \begin{aligned}
        \trace \hat{\rho}^2 &= \sum_n \mel{n}{\sum_{i, j} p_i p_j \braket{\psi_i}{\psi_j} \dyad{\psi_i}{\psi_j}}{n} \\
        &= \sum_{n, i, j} p_i p_j \braket{\psi_i}{\psi_j} \braket{\psi_j}{n} \braket{n}{\psi_i} \\
        &= \sum_{i, j} p_i p_j \braket{\psi_i}{\psi_j} \braket{\psi_j}{\psi_i} \\
        &=  \sum_{i, j} p_i p_j \abs{\braket{\psi_i}{\psi_j}}^2 \\
        &< \sum_{i, j} p_i p_j = 1 = \trace \hat{\rho}.
    \end{aligned}
\]
上式中我们取小于号而不是小于等于号是因为混合态中诸态不可能全部相互平行。
总之，$\hat{\rho}$幂等的充要条件是它描述了一个纯态，且
\begin{equation}
    \trace \hat{\rho}^2 \begin{cases}
        = 1, \quad & \text{for pure states}, \\
        < 1, \quad & \text{for mixed states}.
    \end{cases}
    \label{eq:inequality-of-mixed-state}
\end{equation}
也就是说密度算符能够提供“纯态还是混合态”的信息。于是可以定义一个密度算符的\textbf{纯度}为
\begin{equation}
    \varsigma = \trace \hat{\rho}^2,
\end{equation}
它越接近$1$说明系统越接近纯态。

此外很容易看出密度算符是厄米的。如果各个参与态相互正交，那么密度算符的本征值就是对应的本征态出现的概率。
当然，各个参与态完全可以不正交，但因为我们从密度算符中并不能判断出哪些是参与态，因此总是可以将密度算符使用它自身的本征态展开，不失一般性地假定各个参与态就是密度算符的本征态。
在各个参与态正交时，可以具体地写出任何一个物理量的期望的公式。我们有
\[
    \begin{aligned}
        \hat{\rho} &= \sum_n P(\ket{n}) \dyad{n}, \\
        \expval*{\hat{A}} &= \trace \hat{\rho} \hat{A} \\
        &= \sum_m \mel{m}{\left(\sum_n P(\ket{n}) \dyad{n} \hat{A} \right)}{m} \\
        &= \sum_{m, n} P(\ket{n}) \braket{m}{n} \mel{n}{\hat{A}}{m}, 
    \end{aligned}
\]
从而
\begin{equation}
    \expval*{\hat{A}} = \sum_n P(\ket{n}) \mel{n}{\hat{A}}{n}.
\end{equation}

\subsubsection{复合系统}\label{sec:combining-systems}

本节将讨论，如果我们已有一个总系统的密度算符，而实际上我们只想讨论其中的一部分的行为，那么要如何写出这个部分的密度算符。
将系统分成两部分，其中一部分称为系统1，另一部分称为系统2。
设$\hat{A}$是只和系统1有关的一个算符。记描述系统2的一组基态为$\ket{\chi_i}$；$\ket{\phi_i}$是系统1的一组态，但它们未必满足正交归一化条件。
则系统的任何一个态均形如
\[
    \ket{\psi} = \sum_{i, j} c_{ij} \ket{\phi_i} \ket{\chi_j},
\]
也就是说我们使用系统2的基矢量展开整个系统的态。
从而整个系统的密度算符形如
\[
    \hat{\rho} = \sum_k p_k \sum_{i,j} \abs{c_{k,ij}}^2 \ket{\phi_i} \ket{\chi_j} \bra{\phi_i} \bra{\chi_j}
\]
请注意所谓的“两个系统”并不一定意味着这是空间上隔离的两个系统——我们只不过是把两个态空间直积而成的态空间中关于两个态空间的信息分别称为系统1和系统2。

现在使用$\hat{A}$对系统1做一次测量，得到$A_i$的概率为
\[
    \begin{aligned}
        P(A_i) &= \sum_{j, k} \bra*{A^{(j)}_i} \bra{\chi_k} \hat{\rho} \ket*{A^{(j)}_i} \ket{\chi_k} \\
        &= \sum_{j, k, l, m, n} p_l \abs{c_{l, mn}}^2 \braket*{A_i^{(j)}}{\phi_m} \braket*{\phi_m}{A_i^{(j)}} \braket{\chi_k}{\chi_n} \braket{\chi_n}{\chi_k} \\
        &= \sum_j \mel*{A_i^{(j)}}{\sum_m \left(\sum_{l, n} p_l \abs{c_{l, mn}}^2 \right) \dyad{\phi_m}}{A_i^{(j)}} 
    \end{aligned}.
\]
记
\[
    \hat{\rho}_1 = \sum_m \left(\sum_{l, n} p_l \abs{c_{l, mn}}^2 \right) \dyad{\phi_m}.
\]
每一项的系数看起来有些复杂，不过请注意
\[
    \abs{c_{l, mn}}^2 = P(\ket{\phi_m} \ket{\chi_n} | \ket{\psi_l}),
\]
有
\[
    \sum_{l, n} p_l \abs{c_{l, mn}}^2 = \sum_{l, n} P(\ket{\psi_l}) P(\ket{\phi_m} \ket{\chi_n} | \ket{\psi_l}) = P(\ket{\phi_m}),
\]
也就是说这个系数就是“从系综中随便取一个态做测量结果发现系统1正好就在$\ket{\phi_m}$上”的概率。
从而我们导出
\[
    \hat{\rho}_1 = \sum_m P(\ket{\phi_m}) \dyad{\phi_m}.
\]
这个表达式的形式和\eqref{eq:density-operator}一模一样。
而系统1经过测量得到$A_i$的概率则是
\[
    P(A_i) = \sum_j \mel{A^{(j)}_i}{\hat{\rho}_1}{A^{(j)}_i},
\]
相应的$\hat{A}$的期望值就是
\[
    \begin{aligned}
        \sum_i A_i P(A_i) &= \sum_{i, j} \mel{A^{(j)}_i}{\hat{\rho}_1 A_i}{A^{(j)}_i} \\
        &= \sum_{i, j} \mel{A^{(j)}_i}{\hat{\rho}_1 \hat{A}}{A^{(j)}_i} = \trace_1 \left(\hat{\rho}\hat{A}\right),
    \end{aligned}
\]
其中$\trace$的下标1表示我们是在系统1的希尔伯特空间上做迹运算。
所有这些结果都和\eqref{eq:prop-of-quantity}和\eqref{eq:expectation}完全一致。
因此我们称$\hat{\rho}_1$为\textbf{约化密度算符}。
容易验证，它可以由
\begin{equation}
    \hat{\rho}_1 = \trace_2 \hat{\rho}
\end{equation}
得到。我们说这是把系统2从密度算符中\textbf{迹掉了}。

% TODO：这一操作会让纯态变成混合态

很容易就可以看出，以上推导和\autoref{sec:introduction-of-density-operator}中从纠缠态导出密度算符的方式完全一样。
这是当然的，因为系统1可以和系统2有纠缠，因此人为把系统1孤立出来必然导致\autoref{sec:introduction-of-density-operator}节中的操作。

另一方面，设我们有两个相互独立的系统，称为系统1和系统2。
所谓相互独立指的是对其中一个系统做某些操作（或者说，让其中一个系统和另一些东西产生相互作用）不影响另一个系统的状态。例如，对其中一个系统做测量不会影响另一个系统的状态。
设两个系统的密度算符分别为
\[
    \hat{\rho}_1 = \sum_i P(\ket*{\psi_i^{(1)}}) \dyad*{\psi_i^{(1)}}, \quad \hat{\rho}_2 = \sum_i P(\ket*{\psi_i^{(2)}}) \dyad*{\psi_i^{(2)}}.
\]
现在把系统1和系统2看成同一个系统。实际上，我们是把描述系统1的系综和描述系统2的系综拼成了一个大系综。这个大系综中的态可以写成$\ket*{\psi_i^{(1)}} \otimes \ket*{\psi_j^{(2)}}$的形式。
现在使用这一组态对总系统做一次测量，由于系统1和系统2无关，有
\[
    P(\ket*{\psi_i^{(1)}} \otimes \ket*{\psi_j^{(2)}}) = P(\ket*{\psi_i^{(1)}}) P(\ket*{\psi_j^{(2)}}),
\]
从而，总系统的密度算符就是
\begin{equation}
    \hat{\rho} = \hat{\rho}_1 \otimes \hat{\rho}_2.
    \label{eq:independent-systems-combinition}
\end{equation}
反之也容易验证，如果\eqref{eq:independent-systems-combinition}成立，那么设$\hat{H}_1$仅仅作用在系统1上，则
\[
    \begin{aligned}
        \dv{t} \hat{\rho}_1 \otimes \hat{\rho}_2 &= \frac{1}{\ii \hbar} \comm*{\hat{H}_1}{\hat{\rho}_1 \otimes \hat{\rho}_2} \\
        &= \frac{1}{\ii \hbar} \comm*{\hat{H}_1}{\hat{\rho}_1} \otimes \hat{\rho}_2,
    \end{aligned}
\]
因此对系统1做的操作不影响系统2，反之亦然。
因此，两个系统独立，当且仅当\eqref{eq:independent-systems-combinition}成立。
这又等价于，
\begin{equation}
    (\trace_2 \hat{\rho}) \otimes (\trace_1 \hat{\rho}) = \hat{\rho}.
\end{equation}

以上讨论导致一个显然的推论。如果一个纯态系统的某些自由度与其它自由度从来不发生相互作用（从而也不可能让这些自由度与其它自由度纠缠起来——见\autoref{note:entangled-states}），那么将这些自由度从密度算符中迹掉之后得到的密度算符还是纯态。
从希尔伯特空间的角度也可以得到这个结论，因为如果一个纯态系统的某些自由度与其它自由度从来不发生相互作用，那么系统实际上采取的态矢量一定可以写成前面这些自由度确定的一个态矢量和其余自由度确定的一个态矢量的直积。因此两部分自由度可以被分开处理。

\subsubsection{未归一化的密度算符}\label{sec:relative-density-operator}

以上讨论的密度算符在定义时保证了其系数真的就是对应的态出现的概率。有时我们能够比较容易地计算出某个态出现的概率正比于某个值，即只知道
\begin{equation}
    P(\ket{\psi_i}) \propto f(\psi_i),
\end{equation}
而不容易将它归一化。此时可以定义未归一化的密度算符或者说相对密度算符为
\begin{equation}
    \hat{\rho} = \sum_i f(\psi_i) \dyad{\psi_i},
\end{equation}
定义\textbf{配分函数}
\begin{equation}
    Z = \sum_i f(\psi_i) = \trace \hat{\rho},
\end{equation}
则$\hat{\rho} / Z$就是归一化的密度算符。使用这个关系，我们得到期望值公式为
\begin{equation}
    \expval*{\hat{A}} = \frac{1}{Z} \trace \left(\hat{\rho} \hat{A}\right) = \frac{\trace \left(\hat{\rho} \hat{A}\right)}{\trace \hat{\rho}},
\end{equation}
在参与态为正交归一化基时这就是
\begin{equation}
    \expval*{\hat{A}} = \frac{1}{Z} \sum_n P(\ket{n}) \mel{n}{\hat{A}}{n}.
\end{equation}
纯度公式为
\begin{equation}
    \varsigma = \frac{\trace \hat{\rho}^2}{\trace \hat{\rho}},
\end{equation}
越接近1说明态越纯。

\subsection{熵}

宏观上能够观察的量可以分成两类。一类在微观层面具有良定义，其宏观形式就是它的统计平均。这一类量的例子有能量等，它们的计算已经在\eqref{eq:expectation}中给出了。
还有一类量在微观层面并无明确定义，它们是大量粒子的集体行为涌现出现的结果。这一类物理量也可以通过密度算符得到，但具体方法并没有一定之规。
本节将讨论一个典型的这种涌现出来的物理量。

设$\hat{\rho}$是归一化的密度算符。首先定义%
\footnote{关于下式中的$\ln \hat{\rho}$：设算符$\hat{A}$可被谱展开为
\[
    \hat{A} = \sum_i A_i \dyad{i},
\]
则可以验证，一个解析函数作用在$\hat{A}$上的结果为
\[
    f(\hat{A}) = \sum_i f(A_i) \dyad{i}.
\]
因此即使函数$f$的性质不那么好，我们也规定上式成立。显然如果$\hat{A}$是厄米的，且$f$是实函数，那么$f(\hat{A})$也是厄米的。
}%
\begin{equation}
    S = - \trace (\hat{\rho} \ln \hat{\rho}) = - \expval*{\ln \hat{\rho}}.
    \label{eq:von-neumann-entropy}
\end{equation}
为\textbf{熵}，或称为\textbf{冯诺依曼熵}来和我们将要看到的另一种熵区分。设密度算符被谱展开为
\[
    \hat{\rho} = \sum_n \rho_n \dyad{n},
\]
我们只取其中非零的项。那么熵就可以写成分布函数的函数：
\begin{equation}
    S = - \sum_n \rho_n \ln \rho_n.
\end{equation}
这意味着如果把诸$\ket{n}$一起相同的幺正变换，$S$不变。这就是说，$S$在密度算符做幺正变换时不变，也即
\begin{equation}
    S(\hat{\rho}) = S(\hat{U} \hat{\rho} \hat{U}^{-1}).
\end{equation}
如前所述，$0 < \rho_n \leq 1$，从而$S \geq 0$。

如果系统处于纯态，那么总是有一个态$\ket{\psi}$使密度算符可以写成
\[
    \hat{\rho} = \dyad{\psi},
\]
此时$\rho_n$只有一个，且它的值为$1$，从而$S=0$。反之，如果$S=0$，那么所有的$\rho_n$都是1，因此只有一个$\rho_n$且它是1，因此系统处于纯态。
这意味着熵为$0$是系统处于纯态的充要条件。因此熵可以看成系统偏离纯态的量度，或者说看成“我们对系统有多无知”的量度。

我们已经发现了熵取最小值意味着什么。顺带而来的问题：熵取极大值又意味着什么？我们会看到，这意味着系统达到了平衡态。

设有两个彼此独立的系统，它们各自的密度算符被谱展开为
\[
    \hat{\rho}_1 = \sum_i \rho_i^{(1)} \dyad*{i^{(1)}}, \quad \hat{\rho}_2 = \sum_j \rho_j^{(2)} \dyad*{j^{(2)}},
\]
从而
\[
    \hat{\rho} = \sum_{i,j} \rho_i^{(1)} \rho_j^{(2)} \dyad*{i^{(1)}, j^{(2)}}.
\]
组成的总系统的熵为
\[
    \begin{aligned}
        S(\hat{\rho}) &= - \sum_{i, j} \rho_i^{(1)} \rho_j^{(2)} \ln (\rho_i^{(1)} \rho_j^{(2)}) \\
        &= - \sum_{i, j} \rho_i^{(1)} \rho_j^{(2)} \ln \rho_i^{(1)} - \sum_{i, j} \rho_i^{(1)} \rho_j^{(2)} \ln \rho_j^{(2)} \\
        &= - \sum_i \rho_i^{(1)} \ln \rho_i^{(1)} - \sum_j \rho_j^{(2)} \ln \rho_j^{(2)} \\
        &= S(\hat{\rho}_1) + S(\hat{\rho}_2).
    \end{aligned}
\]
也就是说，彼此独立的系统组成的总系统的熵就是组成它的各个系统的熵之和。
我们只能够得到这个程度的结论：一个系统的熵未必是它的各个子系统的熵之和。
熵对任何系统的可加性只有在更加特定的情况下才能够成立。

需要注意的是随着各种物理过程的发生，冯诺依曼熵并非在所有情况下都会增长。

\subsection{退化到经典情况}\label{sec:back-to-classical}

对纯态，在半经典情况下可以证明这样一个表达式：设$x,p$是一对共轭变量，则
\begin{equation}
    \frac{1}{2\pi} \oint p \dd{x} = \hbar \left(n + \frac{1}{2}\right), \quad n = 0, 1, 2, \ldots.
\end{equation}
这里$n$是量子态的标记，不同$n$对应不同量子态。在系统规模很大时$n$也很大，从而
\begin{equation}
    \oint p \dd{x} \sim 2 \pi \hbar n.
    \label{eq:phase-cell}
\end{equation}
由于等式左边是分析力学中的角变量，是相平面上的闭路积分，这个公式意味着在系统规模很大时，可以这样分析其动力学：使用经典哈密顿力学，但是计算类似于\eqref{eq:phase-cell}这样的积分时应该假定相平面被分成了许多大小为$2\pi \hbar$的格子（所谓\textbf{相格}）。
在系统有$s$个自由度时，单个相格大小为$(2\pi \hbar)^s$。
由于一个相格对应一个$n$，在$\Delta x \Delta p$的范围内共有
\begin{equation}
    \Omega = \frac{\Delta x \Delta p}{(2\pi \hbar)^s}
\end{equation}
个彼此独立的量子态。

相格以一种直观的方式展示了量子力学的不确定性原理：实际上我们并不能同时精确地讨论坐标和动量。

对混合态，可以将一个系综中的各个系统的纯态单独地画在相空间当中，并记这些点的密度为$\rho(x, p, t)$，称为\textbf{密度函数}。
则由经典分析力学的刘维尔定理，有
\begin{equation}
    \pdv{\rho}{t} = [H, \rho].
\end{equation}
方程右边的方括号指的是经典的泊松括号而不是对易子，因为经典情况下哈密顿量是数。
可见，密度算符$\hat{\rho}$在量子统计力学中的地位就是经典统计力学中的密度函数。

\section{平衡态多粒子系统}\label{sec:equilibrium-system}

本节讨论由大量粒子组成的平衡态系统的密度算符以及各种性质。大部分物理系统的平衡态几乎都可以使用这一套框架来描述，因为量子场论自然地导致多粒子态（可以使用单粒子量子力学描述的系统实际上就是使用薛定谔场描述的系统）。
我们假定哈密顿量不显含时间，从而保证平衡态的存在性，而将含时演化留到后面讨论。

\subsection{微正则系综}

\subsubsection{概率分布与密度算符}

\textbf{孤立系统}是指很大（从而它不是可积的），并且和外界有小但确实有的相互作用（从而它的演化轨迹会时不时从一条偏移到另外一条上，但每条轨迹又不会有很大偏离）的系统。
称它为孤立系统是因为宏观上看它和外界没有物质能量交换。
平衡态的孤立系统具有\textbf{各态遍历性}：在一段时间内，系统会经过所有可能的态。%
\footnote{这些条件都是必要的：如果系统很简单，比如说，就是理想的二体问题，那么就算系统和环境有纠缠或者持续的小的相互作用也不会各态遍历——可积系统不会热化。}%
所谓可能指的是和系统已知的各个参数一致，例如如果系统和外界无能量交换，那么所有可能的态就是指能量和初始能量相等的态。%
\footnote{类似于“系统有硬边界”这样的条件，如“系统装在一个盒子里”，可以看成是系统受到一个外加势的作用，这个外加势在盒子内部为零，在盒子外部为无穷大，从而由系统能量有限可以知道，系统中的粒子绝对不会跑到盒子外部去。}%
系统遍历所有可能的态的时间，也就是\textbf{遍历时间}，通常远远小于我们观察的时间尺度。
显然，这就意味着在我们观察的时间尺度上均匀取样地对系统做观察，得到的结果是随机的，因此需要引入一个系综来处理这个问题。%
\footnote{这是又一个虽然没有实际上的随机性，但信息的缺乏意味着我们必须引入概率测度来分析问题的例子。}%
许多系统如果和外界毫无接触，那么并不会有遍历性；但是几乎我们关心的所有系统都或多或少地和外界有小的相互作用。
这种系统达到平衡，且和外界虽有小的相互作用但相互作用对系统能量影响不大，以至于系统总能量可以看成是给定的的情况称为\textbf{微正则系综}。相应的，系统和外界的小的相互作用以及它带来的能量变化称为\textbf{热涨落}。

系统取各个态的概率是多少呢？数学上可以证明，设系统的所有可能的态组成希尔伯特空间，且给定该希尔伯特空间的一组基，则系统取这组基中的任何一个的概率都是一样的。
从而，系统具有某个宏观性质的概率就正比于满足这个性质的正交态的数目。这就是\textbf{等概率原理}，有时也称为\textbf{统计物理基本假设}。
关于“可能的态”需要特殊说明。有些态的不可能性是哈密顿量告诉我们的。例如，如果系统被放置在一个无限深、无限厚的势陷当中，那么系统中的粒子不可能到达势陷外面。还有一些态的不可能性是来自系统的初态。系统的哈密顿量不含时，因此如果系统的初态是一个能量本征态，能量为$E$，那么它无论如何不会演化到一个具有$2E$能量的态上面；同样，如果系统的动力学保证粒子数守恒，那么系统的粒子数也不会发生变化。

守恒量通常都是关于整个系统的，因此通常很大，从而可以和各种尺度的外界扰动（热涨落）有耦合，因此，系统几乎总是处在其所有守恒量的本征态上，于是我们可以毫无顾虑地讨论“系统的守恒量的值”而不用担心叠加态。
我们看到，系统具有的所有守恒量实际上将系统的态空间分成了一个个轨道，每个轨道上的态具有相同的守恒量的值。热涨落让系统可以取同一个轨道上的不同的态，却不能让系统从一个轨道跳跃到另一个轨道。（当然实际上，热涨落还是可以让守恒量发生小的变化的，如可以让能量在一定范围内涨落，也即，轨道是有宽度的，但由于涨落按照定义很小而且相互抵消，因此可以忽略这一点。）
设系统具有的守恒量为$\hat{Q}_1, \hat{Q}_2, \ldots$，记对应轨道上有$\Omega(Q_1, Q_2, \ldots)$个彼此独立的量子态。

当然，这些守恒量当中肯定有一个量，就是系统能量。系统哈密顿量的本征态形如$\ket{E^{(i)}, j}$，其中$\{E^{(i)}\}$指的是一组不同的能量，$j$代表简并。
为方便起见，我们记这些本征态为$\{\ket{n}\}$，并设$E_n$为$\ket{n}$对应的本征态的能量。
请注意$E_n$和$E^{(n)}$是不一样的：后者在$n$不同时没有重复，而前者由于能量简并可以有重复。

在以上讨论的基础上可以直接写出微正则系综的密度算符为
\begin{equation}
    \hat{\rho} = \frac{1}{\Omega(E)} \sum_{E_n = E} \dyad{n},
    \label{eq:microcanonical-ensemble-density-operator}
\end{equation}
其中$\{\ket{n}\}$为系统哈密顿算符的各正交本征态，$\Omega(E)$给出了能量为$E$的哈密顿量的彼此独立的本征态的数目。
我们把具有同一个能量的所有态称为一个\textbf{能级}，那么$\Omega(E)$就是能级$E$的简并度。

\subsubsection{相互接触的系统}\label{sec:contacting-systems}

考虑两个系统，分别称为系统1和系统2。首先记系统1有$\Omega_1 (E)$个彼此独立的能量为$E$的态，系统2有$\Omega_2 (E)$个彼此独立的能量为$E$的态。
如果将两个系统组建成一个总系统，在系统1和系统2无相互作用时，总系统的哈密顿量就是
\[
    \hat{H}_T = \hat{H}_1 + \hat{H}_2,
\]
由于$\hat{H}_1$和$\hat{H}_2$对易，$\hat{H}_T$的本征值就是两者的本征值之和。设总系统有$\Omega_T(E)$个彼此独立的总系统的能量为$E$的态，那么
\[
    \Omega_T (E_T) = \sum_{E_T=E_1^{(m)}+E_2^{(n)}} \Omega_1 (E_1^{(m)}) \Omega_2 (E_2^{(n)}),
\]
或者
\begin{equation}
    \Omega_T (E) = \sum_{n} \Omega_1 (E_1^{(n)}) \Omega_2 (E - E_1^{(n)}),
    \label{eq:total-system-state-number}
\end{equation}
其中$E$为$\hat{H}_T$的某个本征值。
% 由于守恒荷没有交换，可以直接认为守恒荷只提供能量简并

现在让两个系统“接触”，也就是让它们产生一个相对于它们各自的哈密顿量来说比较小的相互作用。此时\eqref{eq:total-system-state-number}就不再适用了，因为总系统的哈密顿量还要加上一个相互作用项，由于系统1和系统2的哈密顿量都可能是离散谱，设$E_1^{(n)}$是系统1哈密顿量的本征值，$E-E_1^{(n)}$却未必是系统2的哈密顿量的本征值！
但由于我们考虑的系统的粒子数都非常大，系统2的能谱近似是连续的，也即，$E-E_1^{(n)}$总是非常接近系统2的一个能级。因此我们接受\eqref{eq:total-system-state-number}。

关于\eqref{eq:total-system-state-number}还有一个值得注意的地方。由于系统1和系统2的能级可以是连续的或者几乎是连续的，$\Omega$应该怎么定义实际上需要进一步澄清。
对能谱连续的情况，设$d(E)$为态密度，然后做以下替换：
\[
    \sum_n \longrightarrow \int , \quad \Omega \longrightarrow d(E) \dd{E},
\]
就得到了正确的结果，也就是
\[
    d_T(E) \dd{E} = \int d_1 (E_1) \dd{E_1} d_2 (E - E_1) (\dd{E} - \dd{E_1}),
\]
即
\begin{equation}
    d_T(E) = \int \dd{E_1} d_1 (E_1) d_2 (E - E_1).
    \label{eq:canonical-state-continue}
\end{equation}
因此我们只需要讨论离散谱的情况，就可以推广到连续谱。
实际上我们完全可以反过来，首先讨论连续谱然后再推广到离散谱。在离散谱情况下，定义
\[
    d(E) = \sum_n \Omega(E^{(n)}) \delta(E - E^{(n)}),
\]
这样得到的$d(E)$是一个一个尖峰。我们取$\epsilon$为能量差的分辨率的尺度，定义
\[
    \Omega_\epsilon (E) = \int_{E-\epsilon/2}^{E+\epsilon/2} \dd{E} d(E),
\]
就恢复到了\eqref{eq:total-system-state-number}。需要注意的是并非所有的$\epsilon$都能够让$\Omega_\epsilon$恢复到$\Omega$。
然而，由于$\Omega(E)$、$d(E)$和$\Omega_\epsilon(E)$之间的换算关系是完全均匀的，当离散谱各能级的间距很小时，可以把等概率原理应用到它们任何一个上面，只要它们是微正则系综中的。 % TODO
因此很多时候并不需要让$\Omega_\epsilon(E)$为实际的处在能级$E$上的量子态个数——实际上，实际计算时也不可能真的算出来实际的处在能级$E$上的量子态个数。
% TODO:进一步说明，、。。关于$\epsilon$的东西我没算清楚过

\subsubsection{熵和温度}\label{sec:entropy-and-temperature}

微正则系综下冯诺依曼熵的计算特别容易。由于\eqref{eq:microcanonical-ensemble-density-operator}的形式非常简单，可以直接得到
\[
    S = - \sum_\text{eigenstate $\ket{n}$} \frac{1}{\Omega(E)} \ln \frac{1}{\Omega(E)},
\]
由于求和号内的表达式并不显含$n$，而求和一共进行了$\Omega(E)$次，我们就得到
\begin{equation}
    S(E) = \ln \Omega(E).
    \label{eq:entropy-and-state-number}
\end{equation}
我们把微正则系综中的冯诺依曼熵写成关于能量的函数，因为系统的哈密顿量只是描写了系统的结构，或者说可能有多少能量，却并没有说明系统实际上有多少能量。当然一般情况下，系统的态可以不是能量本征态，所以也说不上有什么确定的能量，但由于本节仅讨论微正则系综，不会出现这种情况。

实际上，微正则系综的冯诺依曼熵\eqref{eq:entropy-and-state-number}是孤立体系的冯诺依曼熵中最大的。
使用拉格朗日乘子法可以导出这一点。考虑最大化问题
\[
    S = - \trace (\hat{\rho} \ln \hat{\rho}) \quad \text{s.t.} \quad \begin{bigcase}
        \hat{\rho} &= \sum_{E_n=E} \rho_n \dyad{n}, \\
        \trace \hat{\rho} &= 1,
    \end{bigcase}
\]
系统的孤立性意味着系统只能出现在能级$E$上，这也就是上式中我们认为密度算符的所有参与态的能量本征值都是$E$的原因。
$\trace \hat{\rho} = 1$等价于
\[
    \sum_{E_n=E} \rho_n = 1,
\]
且我们有
\[
    S = - \sum_{E_n=E} \rho_n \ln \rho_n,
\]
于是取目标函数为
\[
    u = - \sum_{E_n=E} \rho_n \ln \rho_n + \lambda \left(1 - \sum_{E_n=E} \rho_n\right),
\]
对任意一个$\rho_m$优化，得到
\[
    0 = - \ln \rho_m - 1 - \lambda,
\]
可见所有$\{\rho_n\}$都是相等的，从而
\[
    \hat{\rho} \propto \sum_{E_n=E} \dyad{n},
\]
归一化就得到\eqref{eq:entropy-and-state-number}。因此我们得到\textbf{最大熵原理}：孤立系统达到平衡，当且仅当其冯诺依曼熵达到最大。
只要孤立系统的冯诺依曼熵达到了最大值，它就一定已经平衡，并且服从微正则系综。

实际上，\eqref{eq:entropy-and-state-number}可以作为另一种熵的定义，称为\textbf{玻尔兹曼熵}。
玻尔兹曼熵对彼此独立的系统也具有可加性，因为两个彼此无关的系统组成的总系统的状态数为
\begin{equation}
    \Omega_T = \Omega_1 \Omega_2.
\end{equation}
不过，由于\eqref{eq:entropy-and-state-number}的成立是有条件的，玻尔兹曼熵和冯诺依曼熵是不同的。
两者只有在平衡态孤立体系上才是一样的，此时我们统称它们为\textbf{熵}。

相互接触的系统自然地导出了温度的概念。两个系统在孤立时，它们达到平衡时的状况可以各自使用微正则系综描述，从而
\[
    S_1(E) = \ln \Omega_1 (E), \quad S_2 (E) = \ln \Omega_2 (E).
\]
当两个系统发生接触之后，它们就不再是系统1和系统2的冯诺依曼熵了，而是这两个系统的玻尔兹曼熵
设两个系统分别在能级$E_1$和$E_2$上。现在让它们接触。平衡时它们接触而成的总系统的熵为
\[
    S_T(E_T) = \ln \Omega_T (E_T) = \ln \sum_{n} \Omega_1 (E_1^{(n)}) \Omega_2 (E_T - E_1^{(n)}),
\]
其中
\[
    E_T = E_1 + E_2.
\]
当然，由于两个系统之间的相互作用，它们接触之后会发生能量交换，并产生纠缠，因此平衡后的系统的熵并不是$S_1$和$S_2$的简单相加。
但我们总是可以使用$S_1$和$S_2$写出$\Omega_1$和$\Omega_2$的表达式，得到
\begin{equation}
    S_T(E_T) = \ln \sum_{n} \exp \left(S_1(E_1^{(n)})+S_2(E_T-E_1^{(n)})\right).
    \label{eq:combined-system-entropy}
\end{equation}
请注意被求和的函数随着自变量的增长而增长得非常快。对比很大的系统，我们有
\[
    \Omega \sim 2^N,
\]
其中$N$表示系统的粒子数（具体底数是多少不重要，因为$N$很大时底数不改变数量级），从而
\[
    S \sim N.
\]
因此随着系统规模的增长，$S$可以不受限制地增长，这样，对比很大的系统，\eqref{eq:combined-system-entropy}的值几乎完全由它右边的求和式中最大的一项决定，也就是%
\footnote{实际上这就是计算积分近似值时常用的鞍点法。}
\[
    \begin{aligned}
        S_T &= \ln \max_{E_1^{(n)}} \left( \exp \left(S_1(E_1^{(n)})+S_2(E_T-E_1^{(n)})\right) \right) \\
        &= \max_{E_1^{(n)}} \left(S_1(E_1^{(n)})+S_2(E_T-E_1^{(n)})\right),
    \end{aligned}
\]
由于系统规模很大，能谱几乎是连续的，可以认为$E_1^{(n)}$近似为连续变量，从而可以对它求导，通过计算
\[
    \pdv{E_\star} \left( S_1(E_\star) + S_2(E_T-E_\star) \right) = 0
\]
我们得到
\begin{equation}
    \eval{\pdv{S_1(E)}{E}}_{E=E_\star} = \eval{\pdv{S_2(E)}{E}}_{E=E_T-E_\star}.
    \label{eq:equilibrium-condition-original}
\end{equation}
从而，两系统接触之后形成的总系统平衡时的熵就是
\begin{equation}
    S_T = S_1(E_\star) + S_2(E_T-E_\star),
\end{equation}
其中$E_\star$是\eqref{eq:equilibrium-condition-original}的解。
这也是两系统组成的总系统能够达到的最大熵。

我们注意到一个惊人的事实：如果在两系统接触之前，系统1平衡于能级$E_\star$上，系统2平衡于能级$E_T-E_\star$上，那么系统1和系统2接触之后立刻就达到了平衡，形成了一个能量为$E_T$的总系统。
这是因为两系统接触之前，它们组成的总系统的熵按照熵的叠加性为
\[
    S_1(E_\star) + S_2(E_T-E_\star),
\]
恰好就是两系统接触之后的熵。由于$S_T$是两系统组成的总系统能够达到的最大熵，两系统接触前后的密度算符是完全一样的。
于是对任意一个达到平衡的系统——它未必是孤立的——我们定义物理量\textbf{温度}$T$为
\begin{equation}
    \frac{1}{T} = \pdv{S}{E} = \pdv{\ln \Omega}{E},
\end{equation}
其中的$S$指的是这个系统的玻尔兹曼熵，也就是这个系统孤立平衡时它的冯诺依曼熵。
如果两个系统孤立时具有相同的温度，那么它们接触之后立刻达到平衡。
由于两系统接触前后密度算符没有发生变化，两系统接触之后各自的温度毫无变化。%
\footnote{需要注意的是系统接触后密度算符没有变化只有在两个系统的粒子数都比很大时才成立。正如我们在关于正则系综的论述中会看到的那样，一个与外界接触的系统有一定的可能出现在远离其平均能量的能级上，因此显然，两系统接触后密度算符实际上会有一定的变化。然而，当粒子数很大时，这种变化是可以略去的。}
实际上，两系统接触之后形成的总系统的温度也和两系统的温度一样。这是因为\eqref{eq:equilibrium-condition-original}实际上给出了$E_T$和$E_\star$的函数关系，从而
\[
    \begin{aligned}
        \pdv{S_T}{E_T} &= \pdv{E_T} \left(S_1(E_\star(E_T)) + S_2(E_T-E_\star(E_T))\right) \\
        &= \eval{\pdv{S_1}{E}}_{E=E_\star} \dv{E_\star}{E_T} + \eval{\pdv{S_2}{E}}_{E=E_T-E_\star} \left( 1 - \dv{E_\star}{E_T} \right) \\
        &= \left( \eval{\pdv{S_1}{E}}_{E=E_\star} - \eval{\pdv{S_2}{E}}_{E=E_T-E_\star} \right) \dv{E_\star}{E_T} + \eval{\pdv{S_2}{E}}_{E=E_T-E_\star} \\
        &= \frac{1}{T}.
    \end{aligned}
\]
总之，温度一致的任意两个系统接触之后立刻达到平衡，且接触之后两个系统的温度没有变化，接触之后形成的总系统的温度就是两个系统的温度。
另一方面，设一个孤立系统是两个子系统接触而形成的，当它达到平衡时，我们会发现其子系统的温度就是这个孤立系统的温度。
% TODO：整理一下这里的论证。实际上可以把这里的论证放到热力学那一节里面
综上我们得出结论：温度相同的平衡态系统

\subsection{正则系综}

\subsubsection{正则系综的密度算符}

接下来我们讨论系统和环境有较多能量交换的情况。设系统和环境中的一部分之间有能量传递，且这一部分远大于系统，称其为\textbf{热库}。%
\footnote{由于环境远大于系统，如果热库不远大于系统，总是可以将环境中的另外一些部分加入热库使之远大于系统。}%
我们分别用1来标记系统，用2来标记热库。较小的系统和热库组成了一个总系统，这个总系统宏观上是封闭的，微观上则可以受到环境中其它部分的微小作用，因此它满足各态遍历假设。我们关心的小系统却未必能够满足这个假设。
我们假定系统和热库的相交部分非常小（通常情况是，系统和热库接触的部分只是一个表面），这样两者的相互作用哈密顿量并不大，从而没有必要考虑相互作用能，系统和热库的总能量为
\begin{equation}
    E_T = E_s + E_r,
    \label{eq:total-energy}
\end{equation}
其中$E_s$指系统能量，$E_r$指热库能量。此外，我们还假定除了能量以外，系统和外界的守恒荷不存在耦合。%
\footnote{设系统和外界的动力学由于对称性，有守恒荷$\hat{N}$。设系统具有守恒荷$\hat{N}_1$，外界具有守恒荷$\hat{N}_2$，那么
\[
    \hat{N} = \hat{N}_1 + \hat{N}_2.
\]
守恒性意味着
\[
    0 = \comm*{\hat{H}}{\hat{N}} = \comm*{\hat{H}_1 + \hat{H}_2 + \hat{H}_\text{int}}{\hat{N}_1 + \hat{N}_2},
\]
由于对称性，$\comm*{\hat{H}_1}{\hat{N}_1}$和$\comm*{\hat{H}_2}{\hat{N}_2}$都是零，而又由于系统的哈密顿量不可能指挥关于外界的物理量的演化，外界的哈密顿量也不可能指挥系统的哈密顿量的演化，$\comm*{\hat{H}_1}{\hat{N}_2}$和$\comm*{\hat{H}_2}{\hat{N}_1}$也都是零。那么就需要且只需要
\[
    \comm*{\hat{N}_1}{\hat{H}_\text{int}} + \comm*{\hat{N}_2}{\hat{H}_\text{int}} = 0.
\]
这个方程要成立意味着，或者$\hat{N}_2$恒定，从而$\hat{N}_1$恒定，或者$\hat{H}_\text{int}$起到了一个泵的作用，让系统和外界能够交换守恒荷。

$\hat{H}_3$能否驱动守恒荷的交换对体系的性质会有质的改变，因为它们会导致总系统的状态数取不同的形式，从而分别导出正则系综和巨正则系综。
\label{note:without-other-decoupling}}%
描述这样的系统的系综就是\textbf{正则系综}。

接下来我们需要根据等概率原理计算出系统出现在不同的能级的概率。
由于等概率原理是针对系统和热库组成的总系统而言的，我们需要讨论总系统的状态和系统的状态之间的关系。可以取系统的态矢量的一组基矢量为哈密顿量的本征态，标记它们为
\[
    \ket{E, k},
\]
其中$E$表示能量，$k$表示导致能量简并的一些因素，比如说如果自旋不影响能量，那么$k$就可以是自旋。

记总系统的能量为$E_T$。这个能量会有热涨落，但是大体上可以看成恒定。
在其中系统具有能量$E_1$的总系统状态一共有$\Omega_1 (E_1) \Omega_2 (E_T - E_1)$个，因此
\begin{equation}
    P(E_1) = \frac{\Omega_1(E_1) \Omega_2(E_T-E_1)}{\Omega_T(E_T)},
\end{equation}
具有能量$E_1$的彼此独立的态正好就有$\Omega_1(E_1)$个，其中每一个态出现的概率都是$P(E_1) / \Omega_1 (E_1)$，这样系统的归一化的密度算符就是%
\footnote{这隐含了一个条件：密度算符是对角化的，否则不能够直接用各个态出现的经典概率写出密度算符。
但由于已经达到了稳态，$\hat{\rho}$和$\hat{H}$对易，因此两者可以同时对角化，因此在能量表象$\{\ket{n}\}$下密度算符确实是对角化的。}
\[
    \begin{aligned}
        \hat{\rho} &= \sum_{\text{all states of the system}} \dyad{\text{a state with energy $E_1$}} \frac{P(E_1)}{\Omega_1 (E_1)} \\
        &= \sum_n \dyad{n} \frac{\Omega_2 (E_T - E_{1n})}{\Omega_T(E_T)} \\
        &= \frac{1}{\Omega_T(E_T)} \sum_{n} \dyad{n} \Omega_2 (E_T - E_{1n}).
    \end{aligned}
\]
我们并不知道热库的具体结构，因此也无从分析$\Omega_2(E_T-E_{1n})$的表达式。
然而，注意到热库通常来说都是很大的，因此$E_{1n}$相对$E_T$来说总是很小，因此我们能够通过泰勒展开取第一项来分析问题。
由于$\Omega_2$随着热库规模的增大指数增长，实际上我们不能够直接对$\Omega_2 (E_T - E_{1n})$做展开。要看出为什么，注意到
\[
    \Omega_2 (E_T - E_{1n}) \sim (E_T - E_{1n})^M,
\]
其中$M$与热库规模——例如其粒子数——同阶。这样就有
\[
    \Omega_2 (E_T - E_{1n}) \sim E_T^M \left( 1 - M \frac{E_{1n}}{E_T} + \frac{1}{2} M (M-1) \left(\frac{E_{1n}}{E_T}\right)^2 + \cdots \right),
\]
$M$的巨大数量级意味着取一阶展开有可能并不能达到足够的精度。
为此我们使用一个技巧：展开
\[
    \exp(\ln \Omega_2(E_T-E_{1n})) \sim \exp \left( M \ln (E_T - E_{1n}) \right),
\]
由于$M$不再出现在展开式当中，从$E_{1n}$相比总能量$E_T$很小这个事实就可以直接取一阶展开式了。于是
\[
    \begin{aligned}
        \hat{\rho} &= \frac{1}{\Omega_T(E_T)} \sum_{n} \dyad{n} \Omega_2 (E_T - E_{1n}) \\
        &= \frac{1}{\Omega_T(E_T)} \sum_{n} \dyad{n} \ee^{\ln \Omega_2 (E_T - E_{1n})} \\
        &= \frac{1}{\Omega_T(E_T)} \sum_{n} \dyad{n} \exp \left( \ln \Omega_2 (E_T) - \eval{\pdv{\ln \Omega_2 (E)}{E}}_{E=E_T} E_{1n} + \cdots \right),
    \end{aligned}
\]
仅保留到一阶项，并重新定义常数，就得到
\begin{equation}
    \hat{\rho} = \frac{1}{Z} \sum_n \dyad{n} \ee^{-\beta E_n} = \frac{1}{Z} \sum_{n, i} \ee^{-\beta E^{(n)}} \Omega(E^{(n)}) \dyad{E^{(n)}, i}.
    \label{eq:canonical-ensemble-density-operator}
\end{equation}
这里我们已经为了书写简便将$E_{1n}$简写为了$E_n$，因为一旦得到了\eqref{eq:canonical-ensemble-density-operator}，我们就完全只使用系统以及一些常数得到了系统的状态，而不再有必要考虑热库的结构了。
但热库并非对系统的状态毫无影响。可以看到
\[
    \beta = \eval{\pdv{\ln \Omega_2 (E)}{E}}_{E=E_T},
\]
由于热库远大于系统，$E_T$近似就是热库的能量$E_2$，于是
\begin{equation}
    \beta = \eval{\pdv{\ln \Omega_2 (E)}{E}}_{E=E_2} = \frac{1}{T}.
\end{equation}
这里$T$指的是热库的温度，由于系统和热库共同达到了平衡，这就是系统的温度。
容易看出归一化因子$Z$就是\autoref{sec:relative-density-operator}中提到的配分函数，于是
\begin{equation}
    Z = \trace \ee^{-\beta \hat{H}} = \sum_n \ee^{-\beta E_n} = \sum_{E^{(n)}} \Omega(E^{(n)}) \ee^{-\beta E^{(n)}}.
\end{equation}
这里将$\Omega_1(E)$简写为$\Omega(E)$，因为有了\eqref{eq:canonical-ensemble-density-operator}之后就不再需要考虑热库了。
注意到$\Omega(E)$的“分辨率”，或者说能量相差多小的量子态被看作是在同一能级上，完全不影响\eqref{eq:canonical-ensemble-density-operator}。

因为各$\ket{n}$彼此正交，\eqref{eq:canonical-ensemble-density-operator}意味着，能量$E^{(n)}$出现的概率为
\begin{equation}
    P(E^{(n)}) = \frac{\Omega(E^{(n)})}{Z} \ee^{-\beta E^{(n)}}.
    \label{eq:boltzmann-distribution}
\end{equation}
这种较高的能量出现的概率指数下降的分布为\textbf{玻尔兹曼分布}。
与微正则系综不同，正则系综中由于热库的存在，系统可以出现在不同能量的能级上。
这也就是微正则系综在名称上似乎比正则系综“小”的原因：微正则系综中系统可能出现的状态少于正则系综。
玻尔兹曼分布的表达式中，随着能量上升，$\exp (-\beta E)$快速下降，而另一方面$\Omega(E)$却在上升——这是组合学的必然结论，因为
\[
    \hat{H} = \sum_{\text{single particle}} \hat{H}_i + \text{interaction},
\]
系统在较低的能级上时，所有粒子都应该具有较低的能量（否则，如果一些粒子的能量很高，另一些粒子的能量就变成了负数，矛盾），而系统在较高的能级上时，可以所有粒子都具有较高的能量，也可以有一些粒子能量很低而另一些粒子能量很高。
因此最后的$P(E)$与$E$的关系会是一个峰：$E$较低时指数因子$\exp (-\beta E)$不是特别小，随着$E$增长，$\Omega(E)$快速增长；而当$E$很大时，指数因子完全盖过了$\Omega(E)$带来的增长。
% TODO：峰很窄

为方便起见，常定义
\begin{equation}
    \rho_n = \mel{n}{\hat{\rho}}{n} = \frac{1}{Z} \ee^{-\beta E_n},
\end{equation}
并设函数$\rho(E)$为一个满足
\begin{equation}
    \rho(E_n) = \rho_n
\end{equation}
的且足够平滑的函数，称为\textbf{分布函数}。这样一来，
\begin{equation}
    P(\text{energy is $E$}) = \Omega(E) \rho(E).
\end{equation}
在能谱几乎是连续的情况下，这就是
\[
    \dd{P} = \dd{\Omega} \rho(E),
\]
从而
\begin{equation}
    \rho(E) = \dv{P}{\Omega}.
\end{equation}
相应的，概率相对能量的密度为
\begin{equation}
    W(E) = \dv{P}{E} = \dv{P}{\Omega} \dv{\Omega}{E} = \rho(E) \dv{\Omega}{E}.
    \label{eq:canonical-ensemble-probablity-density}
\end{equation}

\subsubsection{物理量的期望值}

下面计算各物理量的期望值。能量的期望可以直接从配分函数中读出来。注意到
\[
    \bar{E} = \expval*{\hat{H}} = \sum_i E^{(i)} P(E^{(i)}) = \frac{1}{Z} \sum_i E^{(i)} \Omega(E^{(i)}) \ee^{- \beta E^{(i)}} = \frac{1}{Z} \sum_\text{eigenstate $\ket{n}$} E_n \ee^{-\beta E_n} ,
\]
可以得到
\begin{equation}
    \bar{E} = \expval*{\hat{H}} = - \frac{1}{Z} \pdv{Z}{\beta} = - \pdv{\ln Z}{\beta}.
    \label{eq:canonical-expectation-of-energy}
\end{equation}
其余物理量的计算略微麻烦一些。为方便起见，先考虑一个受到外部扰动的哈密顿量
\begin{equation}
    \hat{H}' = \hat{H} + \lambda \hat{A},
\end{equation}
记它的配分函数为
\begin{equation}
    Z(\beta, \lambda) = \trace \ee^{-\beta (\hat{H} + \lambda \hat{A})}
    \label{eq:partition-function-with-disturbance}
\end{equation}
显然，取$\lambda = 0$我们就回退到了没有扰动的系统的配分函数。
我们尝试写出\eqref{eq:partition-function-with-disturbance}在$\lambda$很小时的表达式。
在$\lambda$很小时，$\hat{H} + \lambda \hat{A}$的各个本征态仍然满足正交归一化条件（实际上不管$\lambda$多大都是如此），且相对诸$\ket{n}$只有微小的偏移，由微扰论我们知道，略微偏离态$\ket{n}$的$\hat{H} + \lambda \hat{A}$的本征值约为
\[
    E'_n = E_n + \lambda \mel{n}{\hat{A}}{n},
\]
从而我们有
\[
    \begin{aligned}
        Z(\beta, \lambda) &= \sum_{\text{eigenstate $\ket{n'}$}} \ee^{- \beta E'_n} \\
        &= \sum_{\text{eigenstate $\ket{n}$}} \ee^{- \beta (E_n + \lambda \mel{n}{\hat{A}}{n})}.
    \end{aligned}
\]
第二个等号要求$\lambda$充分小。
因此在$\lambda$很小时，
\[
    \begin{aligned}
        \pdv{Z(\beta, \lambda)}{\lambda} &= \sum_{\text{eigenstate $\ket{n}$}} (-\beta \mel{n}{\hat{A}}{n}) \ee^{-\beta (E_n + \lambda \mel{n}{\hat{A}}{n})} \\
        &= - \beta \sum_{\text{eigenstate $\ket{n}$}} \mel{n}{\hat{A}}{n} \ee^{- \beta E_n} \quad \text{as $\lambda \to 0$},
    \end{aligned}
\]
而
\[
    \expval*{\hat{A}} = \frac{1}{Z} \sum_\text{eigenstate $\ket{n}$} \mel{n}{\hat{A}}{n} \ee^{- \beta E_n},
\]
因此
\begin{equation}
    \expval*{\hat{A}} = - \frac{1}{\beta Z} \eval{\pdv{Z(\beta, \lambda)}{\lambda}}_{\lambda = 0} = - \frac{1}{\beta} \eval{\pdv{\ln Z(\beta, \lambda)}{\lambda}}_{\lambda=0}.
\end{equation}
于是我们从配分函数得到了所有物理量的期望。

在我们有一系列$\{\hat{A}_i\}_i$时，可以定义
\begin{equation}
    Z(\beta, J) = \trace \ee^{-\beta \hat{H} + \sum_i J_i \hat{A}_i },
\end{equation}
仿照上面的论证，可以得到
\begin{equation}
    \expval*{\hat{A}_{k_1} \hat{A}_{k_2} \cdots \hat{A}_{k_n}} = \frac{1}{Z(\beta,0)} \eval{\frac{\partial^n Z}{\partial J_{k_1} \partial J_{k_2} \cdots \partial J_{k_n}}}_{J=0}.
\end{equation}
在连续极限下，$\hat{A}_i$变成了量子场$\hat{A}(\vb*{x})$，
% TODO:和量子场论的联系。注意$\hbar$的地位和$T=1/\beta$的地位是一样的。不同的$T$对应着不同的行为，正如不同的$\hbar$（实际上$\hbar$固定不变，场值在变，但也可以等效地认为场值不变而$\hbar$在变）对应不同的行为。同样会有相变，统计有相变，量子场论也有相变。可以额外给场论定义一个“能标”，这样
% 同样也可以把$\sum_i J_i A_i$看成外来激励，算费曼图
我们这就得到了所谓的\textbf{统计场论}。

\subsubsection{与微正则系综之间的关系}

我们使用微正则系综导出了正则系综。本节我们将看到，在粒子数很大时正则系综实际上就是微正则系综。
我们知道$P(E)$和$E$之间的关系\eqref{eq:boltzmann-distribution}是一条有一个峰的曲线，由于
\[
    \Omega \sim 2^N, \quad E \sim N,
\]
当粒子数很大时\eqref{eq:boltzmann-distribution}中的两个因子一个快速上升一个快速下降，因此当粒子数很大时\eqref{eq:boltzmann-distribution}实际上是一个非常尖锐的峰。
大粒子数意味着我们可以把能谱看成连续的，从而峰的位置$E_\text{peak}$可以通过求解
\[
    \eval{\pdv{E} (\Omega(E) \ee^{-\beta E})}_{E=E_\text{peak}} = 0
\]
或者等价的
\[
    \beta = \eval{\pdv{\ln \Omega}{E}}_{E=E_\text{peak}}
\]
得到，其中$\Omega$指的是系统的简并数。既然\eqref{eq:boltzmann-distribution}仅在$E_\text{peak}$附近非零，\eqref{eq:canonical-ensemble-density-operator}就成为
\[
    \hat{\rho} = \frac{1}{Z} \sum_i \Omega(E_\text{peak}) \ee^{-\beta E_\text{peak}} \dyad{E_\text{peak}, i},
\]
从而
\[
    Z = \Omega(E_\text{peak}) \ee^{-\beta E_\text{peak}},
\]
代入\eqref{eq:canonical-expectation-of-energy}，得到
\[
    \bar{E} = E_\text{peak},
\]
结合以上各式，在粒子数很大时，我们有
\begin{equation}
    \hat{\rho} = \frac{1}{\Omega(\bar{E})} \sum_{E_n=\bar{E}} \dyad{n}. 
\end{equation}
因此在粒子数很大时，正则系综实际上就是一个以$\bar{E}$为能量的微正则系综。
从以上推导过程也可以看出，微正则系综实际上只是追踪了$P(E)-E$曲线峰值附近的那一部分系统，而正则系综考虑了整条曲线，但在粒子数很大时，两者并无区别，因为远离峰的状态几乎不可能出现。

\subsubsection{热力学性质}

首先指出一个事实：玻尔兹曼分布\eqref{eq:canonical-ensemble-density-operator}是让熵取极大值的分布。可以使用拉格朗日乘子法导出这一点。记$\hat{\rho}$为归一化的密度算符，则%
\footnote{这只是一个条件，但我们只需要说明“所有可能的熵极大值都对应吉布斯平衡态”即可，如果只使用这个条件就能够推出这个结论，那就没有问题。}
\[
    \trace \hat{\rho} = 1.
\]
平衡态时系统的能量的期望恒定，于是
\[
    \trace (\hat{\rho} \hat{H}) = E = \const.
\]
从而，只需要最大化
\[
    S = - \trace (\hat{\rho} \ln \hat{\rho}) \quad \text{s.t.} \; \begin{bigcase}
        \trace \hat{\rho} &= 1, \\
        \trace (\hat{\rho} \hat{H}) &= E
    \end{bigcase}
\]
即可。取目标函数为
\[
    u = - \trace (\hat{\rho} \ln \hat{\rho}) + \gamma (E - \trace (\hat{\rho} \hat{H})) + \gamma' (1 - \trace \hat{\rho}),
\]
对$\hat{\rho}$优化得到
\[
    \ln \hat{\rho} + 1 + \gamma \hat{H} + \gamma' = 0,
\]
从而得到
\[
    \hat{\rho} = \exp (-(1+\gamma')) \exp ( - \gamma \hat{H}).
\]
重新定义常数，得到
\[
    \hat{\rho} = \frac{1}{Z} \ee^{-\beta \hat{H}}.
\]
由于$\hat{\rho}$的迹为1，自然的就有
\[
    Z = \sum_\text{eigenstate $\ket{n}$} \ee^{-\beta E_n}.
\]
这正是玻尔兹曼分布。这表明，任何系统到达平衡态时熵都取极大值。

熵在平衡态的表达式还可以使用分布函数写出。首先我们有
\[
    S = - \expval*{\ln \hat{\rho}} = - \expval*{\ln \rho_n},
\]
而$\rho_n$的对数和能量之间有线性关系：
\[
    \ln \rho_n = - \beta E_n - \ln Z,
\]
于是
\[
    \expval*{\ln \rho_n} = \ln \rho(\bar{E}),
\]
我们就得到
\begin{equation}
    S = - \ln \rho(\bar{E}).
\end{equation}

这个表达式又让我们得以获得一个和微正则系综非常类似的熵表达式。假定系统粒子数足够多以至于能谱基本上是连续的。
我们知道系统出现在能级$E$上的概率和$E$之间的关系是一个先上升后下降的曲线，因此通过
\begin{equation}
    W(\bar{E}) \Delta E = 1
\end{equation}
定义的$\Delta E$量度了峰的宽度。
回顾\eqref{eq:canonical-ensemble-probablity-density}，我们有
\[
    \rho(\bar{E}) \eval{\dv{\Omega}{E}}_{E=\bar{E}} \Delta E = 1.
\]
马上可以注意到，
\begin{equation}
    \Delta \Omega = \eval{\dv{\Omega}{E}}_{E=\bar{E}} \Delta E
\end{equation}
给出了峰附近的态的数目（只具有数量级的意义，因为准确的值需要通过积分算出来），于是
\[
    \rho(\bar{E}) = \frac{1}{\Delta \Omega},
\]
从而
\begin{equation}
    S = \ln \Delta \Omega.
    \label{eq:canonical-entropy-and-number-of-states}
\end{equation}
关于\eqref{eq:canonical-entropy-and-number-of-states}的导出有几个应当说明的地方。首先，它的导出一定依赖于能谱几乎连续这一事实，否则$\bar{E}$不一定会落在任何一个能级上，则类似于$W(\bar{E})$（既然能谱离散，它实际上是$\Omega(E)$乘上一个$\delta$函数）这样的表达式全部为零，因此不可能导出\eqref{eq:canonical-entropy-and-number-of-states}。
然而，一旦能谱连续，出现在\eqref{eq:canonical-entropy-and-number-of-states}中的对数函数中的$\Delta\Omega$就不可能是真正的“某个能级上的独立状态数”，因为既然$\Omega$关于$E$连续分布，一个完全确定的$E$对应的独立状态数实际上是零。
因此我们通过计算“峰附近的独立状态数”引入了一个$\Delta\Omega$，这才让\eqref{eq:canonical-entropy-and-number-of-states}成立。
$\Delta\Omega$可以不是任何一个实际的能级上的独立状态数。
最后，我们能够得到\eqref{eq:canonical-entropy-and-number-of-states}是可以预期的，因为在粒子数很大时，正则系综实际上就是微正则系综，因此只有峰附近的状态才是重要的，于是做替换$\Omega\longrightarrow \Delta\Omega$就可以。

通过经典统计力学的论证也可以得到类似的一个公式。但由于经典统计力学中不可能良定义一个状态数（在本文展示的量子统计力学首先考虑分散的能级，然后推广到连续谱，而经典统计力学中任何东西都是连续的），朴素地写下
\[
    S = \ln \Omega
\]
将会得到一个无穷大的结果，因为$\Omega$是零。因此我们只能对相空间做一个粗粒化，来获得有限的结果，这就是
\[
    S = \ln \Omega + \const.
\]
可以验证通过这样的方式得到的熵和平衡态热力学中得到的熵具有同样的性质。
不同的粗粒化方案导致不同的常数，因此相当奇怪的，通过经典统计力学竟然不能得到确定的熵的表达式！\autoref{sec:back-to-classical}则告诉我们，只要将相空间看成一系列大小为$(2\pi \hbar)^s$的相格，就能得到正确的结果，那就是
\begin{equation}
    S = \ln \frac{\Delta x \Delta p}{(2\pi\hbar)^s}.
\end{equation}

实际上，也可以通过配分函数计算熵。直接使用冯诺依曼熵的定义，可以计算得到
\begin{equation}
    S = \ln Z - \frac{\beta}{Z} \pdv{\ln Z}{\beta}.
\end{equation}

\subsection{巨正则系综}\label{sec:grand-canonical-ensemble}

现在我们考虑对系统的更加精细的描写。我们考虑系统还具有能量以外的守恒荷，这样得到的系综称为\textbf{巨正则系综}。

设系统内有$s$种不同的守恒荷，它们记作$\hat{N}_1, \hat{N}_2, $等等，则系统的哈密顿量和这些守恒荷算符对易。
然而，系统中的守恒荷却未必守恒，因为系统可以和外界交换这些守恒荷，例如整个宇宙中的电荷守恒，但是具体一个绝缘体上的静电却可以不守恒，因为我们可以给它电荷或者从它上面导出电荷。（在量子力学中怎么处理这种情况见\autoref{note:without-other-decoupling}）
我们将会和系统交换守恒荷的那部分环境称为\textbf{粒子库}，因为守恒荷通常都是粒子携带的。
系统中的守恒荷加上粒子库中的守恒荷的和是守恒的，因为总系统中的守恒荷算符和总系统的哈密顿量对易，而总系统中的一切都按照总系统的哈密顿量（系统的哈密顿量只是它的一部分）发生时间演化。

由于系统的哈密顿量和各个守恒荷算符彼此对易，系统的哈密顿量的本征态可以被标记为
\[
    \ket{E^{(i)}, N_1^{(j_1)}, N_2^{(j_2)}, \ldots, k},
\]
我们使用和\autoref{sec:contacting-systems}中一样的记号，使用右上角标标记各可观察量的不同本征值。$k$指的是可能出现的额外的自由度，因为仅仅使用守恒荷可能不足以完全区分$\hat{H}$的简并本征态。

仿照\eqref{eq:total-system-state-number}，我们有
\begin{equation}
    \begin{aligned}
        \Omega_T (E, N_1, \ldots, N_s) = \sum_{m, n_1, \ldots, n_s} &\Omega_1 (E_1^{(m)}, N_{1,1}^{(n_1)}, \ldots, N_{1,s}^{(n_s)}) \\
        &\times \Omega_2(E-E_1^{(m)}, N_1 - N_{1,1}^{(n_1)}, \ldots, N_s - N_{1,s}^{(n_s)}).
    \end{aligned}
\end{equation}
同样，$E-E^{(m)}_1$虽然可能并不是热库的哈密顿量的本征值，但由于热库很大，它总是几乎是热库的哈密顿量的本征值。
按照\autoref{sec:contacting-systems}中的方式也可以得到连续能谱情况下的表达式。由于连续能谱意味着守恒荷很大，我们也可以把诸$N_i$看成连续的，从而做替换
\[
    \sum \longrightarrow \int, \quad \Omega \longrightarrow d(E, N_1, \ldots, N_s) \dd{E} \dd{N_1} \cdots \dd{N_s},
\]
最终得到
\begin{equation}
    \begin{aligned}
        d_T(E, N_1, \ldots, N_s) = \int \dd{E_1} \dd{N_{1,1}} \cdots \dd{N_{1,s}} &d_1(E_1, N_{1,1}, \ldots, N_{1,s}) \\
        &\times d_2(E-E_1, N_1-N_{1,1}, \ldots, N_s-N_{1,s}).
    \end{aligned}
    \label{eq:grand-canonical-ensemble-states}
\end{equation}

推导密度算符的方法和正则系综是完全一样的。将系统、热库和粒子库放在一起组成总系统，由于总系统适用微正则系综，我们有
\[
    P(E_{1,1}, N_{1,1}, \ldots, N_{1,s}) = \frac{\Omega_1(E_{1,1}, N_{1,1}, \ldots, N_{1,s})\Omega_2(E_T-E_{1,1}, N_{T,1}-N_{1,1}, \ldots, N_{T,s}-N_{1,s})}{\Omega(E_T, N_{T,1}, \ldots, N_{T,s})},
\]
在数学上$E,N_1,\ldots$的地位完全是相同的，因此我们可以照搬正则系综的推导，得到
\[
    \hat{\rho} = \const \cdot \sum_n \dyad{n} \exp\left(-\beta E_n - \sum_i \alpha_i N_{i,n}\right),
\]
或者通过重新定义常数，有
\begin{equation}
    \hat{\rho} = \frac{1}{\Xi} \sum_n \dyad{n} \exp \left(-\beta \left(E_n - \sum_i \mu_i N_{i,n}\right)\right) = \frac{1}{\Xi} \ee^{- \beta \left( \hat{H} - \sum_i \mu_i \hat{N}_i \right) }.
    \label{eq:grand-canonical-ensemble-density-operator}
\end{equation}
同样我们使用$E,N_1,\ldots$特指系统的能量、第一种守恒荷、第二种守恒荷，等等。
其中$\Xi$称为\textbf{巨配分函数}，为
\begin{equation}
    \Xi =  \sum_n \exp \left(-\beta \left(E_n - \sum_i \mu_i N_{i,n}\right)\right) = \trace \ee^{- \beta \left( \hat{H} - \sum_i \mu_i \hat{N}_i \right) }.
\end{equation}

在守恒荷是由$U(1)$对称性提供的情况下，它实际上就是粒子数：$U(1)$对称性要求哈密顿量中的每一项含有同样数目的产生算符和湮灭算符，这样给产生算符乘上一个单位复数因子$\ee^{\ii \alpha}$时湮灭算符被乘上了$\ee^{ - \ii \alpha}$，于是哈密顿量整体不变；哈密顿量中的每一项含有同样数目的产生算符和湮灭算符又意味着，不会有粒子数的变化。
很多教科书会选择直接讨论以粒子数为守恒荷的巨正则系综，不过巨正则系综不仅仅适用于这种情况。

表面上看，巨正则系综似乎应该也是一种正则系综，因为在已知$d(E, N_1, \ldots, N_s)$时，仅仅考虑量子态在能量上的分布，就得到
\[
    d(E) = \int \dd{N_1} \dd{N_2} \cdots \dd{N_s} d(E, N_1, \ldots, N_s),
\]
在\eqref{eq:grand-canonical-ensemble-states}中应用此式，积掉所有守恒荷变量就得到
\[
    d_T(E) = \int \dd{E_1} d_1(E_1) d_2(E-E_1),
\]
这正是正则系综的状态数公式\eqref{eq:canonical-state-continue}。从这个公式结合等概率原理就能够推导出正则系综。
但如果真的这样计算，得到的密度算符中将不会出现$\mu \hat{N}$项，从而产生矛盾。差错出现在什么地方？
其原因在于，由于系统和粒子库可以发生守恒荷的交换，系统具有不同守恒荷的态出现的概率并不相等。

这又产生了一个新的问题。如果系统和外界虽然能够交换某种守恒荷，但是交换速度很慢，那又会怎么样？显然，系统从一个任意的态出发，会很快收敛到一个正则系综；但随后，由于系统和外界终究还是会交换守恒荷，系统将会经历一个时间尺度更长的过程，从（近似的）正则系综过渡到巨正则系综。
这种情况下，是将系统看成正则系综还是巨正则系综完全取决于要讨论的问题的时间尺度是不是足够看到系统和外界交换较多的守恒荷。

% TODO：所以实际上完全可以这样导出各种系综：把微正则系综的密度算符迹掉热库，得到正则系综；迹掉一个热库和粒子库，得到巨正则系综，等等。

虽然如此，巨正则系综和正则系综并非没有联系。有两种方法可以将一个巨正则系综的问题转化为一个正则系综的问题。\eqref{eq:grand-canonical-ensemble-density-operator}由于$\hat{H}$和诸守恒荷算符对易，可以写成
\[
    \hat{\rho} = \frac{1}{\Xi} \ee^{-\beta \hat{H}} \ee^{\beta \sum_i \mu_i \hat{N}_i},
\]
于是可以把守恒荷算符部分迹掉%
\footnote{回顾\autoref{sec:combining-systems}节中关于约化密度算符的论述，我们把系统哈密顿量以及额外的自由度$k$提供的信息看成一个系统，把系统守恒荷算符提供的信息看成另一个系统，将密度算符中守恒荷部分求迹，就能够得到一个约化密度算符。}，得到
\begin{equation}
    \trace_{\hat{N}} \hat{\rho} = \frac{1}{\Xi} \trace \left( \ee^{\beta \sum_i \mu_i \hat{N}_i} \right) \ee^{-\beta \hat{H}}.
    \label{eq:trace-out-particle-number}
\end{equation}
因此凡是只通过$\hat{H}$和$\Xi$就能够得到的信息也可以通过密度算符$\trace_{\hat{N}} \hat{\rho}$连同一个按照\eqref{eq:partition-function-with-disturbance}做过扰动的配分函数$Z(\beta, \lambda)$计算得到，因为巨配分函数$\Xi$正好具有\eqref{eq:partition-function-with-disturbance}的形式，因此它正是正则系综受到守恒荷算符扰动之后得到的配分函数。从而，从今以后没有必要特别明确地区分巨配分函数和正则系综的配分函数——两者实际上是一回事。
但解析求解时，守恒荷算符的出现实际上可以简化计算，因此巨正则系综仍然是非常有用的。

第二种将巨正则系综和正则系综联系起来的方式是，注意到我们可以通过一些宏观的论证来比较容易地计算出化学势（见\autoref{sec:from-statistical-to-thermo}），那么诸化学势实际上是已知的，所以我们可以重新定义哈密顿量为
\[
    \hat{H}_\text{eff} = \hat{H} - \sum_i \mu_i \hat{N}_i,
\]
则以$\hat{H}_\text{eff}$为哈密顿量的正则系综正是以$\hat{H}$为哈密顿量的巨正则系综。当然，$\hat{H}_\text{eff}$与其说是哈密顿量，不如说是等效能量，因为它并不能够指导物理量做时间演化，而且只在平衡态下有良好定义。

最后，我们总是可以让所有化学势都取零，此时巨正则系综就回退到了正则系综。因此，形式上我们可以将巨正则系综当成平衡态系统的密度算符的一般形式。

现在我们来分析怎么从巨配分函数计算各种物理量。为了书写方便，我们定义
\begin{equation}
    \alpha_i = - \beta \mu_i,
\end{equation}
这样就有
\begin{equation}
    \Xi(\beta, \alpha) = \sum_n \ee^{-\beta E_n - \sum_i \alpha_i N_{i,n}},
\end{equation}
守恒荷前面的系数在使用$\beta$和$\alpha$（而不是化学势）表示时就和$\beta$无关了；这个$\alpha$当然和以守恒荷算符为扰动的\eqref{eq:partition-function-with-disturbance}中的$\beta\lambda$具有一样的作用。
通过和正则系综类似的方法，可以计算出
\begin{equation}
    \expval*{\hat{N}_k} = - \pdv{\ln \Xi}{\alpha_k}.
    \label{eq:expectation-of-charge-grand}
\end{equation}
若使用$\beta$和$\mu$为变量，有
\begin{equation}
    \expval*{\hat{H}} = - \pdv{\ln \Xi}{\beta} + \sum_i \frac{\mu_i}{\beta} \pdv{\ln \Xi}{\mu_i},
\end{equation}
若使用$\beta$和$\alpha$为变量，则有
\begin{equation}
    \expval*{\hat{H}} = - \pdv{\ln \Xi}{\beta}.
    \label{eq:expactation-of-energy-grand}
\end{equation}
熵的表达式使用$\beta$和$\mu$为变量，是
\begin{equation}
    S = \ln \Xi - \beta \pdv{\ln \Xi}{\beta} - \sum_j \mu_j \pdv{\ln \Xi}{\mu_j},
\end{equation}
使用$\beta$和$\alpha$为变量则是
\begin{equation}
    S = \ln \Xi - \beta \pdv{\ln \Xi}{\beta} - \sum_j \alpha_j \pdv{\ln \Xi}{\alpha_j}
\end{equation}

\subsection{从量子统计退化到经典统计}

大致的方法：剖分相格、将所有算符视作对角化的

\subsection{对单位制的说明}

% 玻尔兹曼常数，等等

\section{热力学}

\subsection{热力学的基本框架}

本节给出的所有假设都是平衡态统计力学的推论。然而，只使用这些假设就能够推导出所有热力学涉及的结论。
因此，热力学可以被构造为一个独立于任何具体的统计物理理论的公理系统。只要其公理在某个统计物理理论下正确，整个热力学在这个公理系统下就是正确的。

在热力学中我们也还是讨论系统，系统可以是平衡态的也可以是非平衡态的。
从系统状态到实数的连续函数称为\textbf{状态函数}。由于热力学不分析系统的内部结构（这些要留给统计物理），实际上我们做的正好相反：我们使用状态函数来标记一个系统的宏观状态，这些状态函数称为\textbf{热力学坐标}。%
\footnote{所谓“宏观状态”指的是“尺度足够大以至于可以使用经典力学描述的状态”。}%
状态函数可以是某个良定义的可观察量的期望值及其函数，比如能量，也可以是某个涌现出来的量，比如说熵或者温度。

在热力学的框架下我们不能严格定义“平衡”，因为这涉及系统内部的结构，因而需要使用某个统计理论来定义。
但可以确定的是，“平衡”意味着诸宏观量不发生变化，从而，系统的热力学坐标不发生变化。
平衡态的系统仍然可能出现微观层面的变化，正如我们在统计力学中看到的那样，它可以遍历所有被允许的态、出现在不同的能级上，等等。
我们还假设在系统达到平衡之后，其状态可以完全由状态函数描写。回顾在\autoref{sec:equilibrium-system}中我们仅仅使用系统的能量、温度等参数就写出了其密度算符，平衡态统计物理确实支持这个假设。

\subsubsection{热力学第零定律与温度}

我们称两个系统热平衡，当且仅当，它们接触之后形成的总系统立即达到平衡，也就是说两个系统接触之后其状态函数不发生变化。
引入\textbf{热力学第零定律}：设有已经达到平衡的三个系统$A,B,C$，若系统$A$和系统$B$热平衡，系统$B$和系统$C$热平衡，那么系统$A$和系统$C$接触之后也能够立即达成平衡。
这个基本假设实际上意味着我们可以引入\textbf{热力学温度}。
由于平衡系统可以使用状态函数完全描写，两个系统是否热平衡完全取决于这两个系统的热力学坐标。
于是，记$A_1, A_2, \ldots$为系统$A$的热力学坐标，记$B_1, B_2, \ldots$为系统$B$的热力学坐标，记$C_1, C_2, \ldots$为系统$C$的热力学坐标，那么可以找到三个函数$f_{AB}, f_{BC}, f_{AC}$，使得$A$与$B$热平衡、$B$与$C$热平衡、$A$与$C$热平衡的充要条件分别是
\[
    f_{AB} (A_1, A_2, \ldots, B_1, B_2, \ldots) = 0,
\]
\[
    f_{BC} (B_1, B_2, \ldots, C_1, C_2, \ldots) = 0,
\]
以及
\[
    f_{AC} (A_1, A_2, \ldots, C_1, C_2, \ldots) = 0. 
\]
显然，$A$和$C$热平衡的充要条件又可以写成
\[
    C_1 = F_{AC} (A_1, A_2, \ldots, C_2, \ldots),
\]
$B$和$C$热平衡的充要条件也可以写成
\[
    C_1 = F_{BC} (B_1, B_2, \ldots, C_2, \ldots).
\]
这样一来，$A$和$C$热平衡且$B$和$C$热平衡的充要条件就是
\begin{equation}
    F_{AC} (A_1, A_2, \ldots, C_2, \ldots) = F_{BC} (B_1, B_2, \ldots, C_2, \ldots).
    \label{eq:ac-and-bc-equilibrium}
\end{equation}
这个方程的解集似乎可以含有$C_2, C_2, \ldots$。然而，请注意$A$和$C$热平衡且$B$和$C$热平衡意味着$A$和$B$热平衡，也就是
\begin{equation}
    f_{AB} (A_1, A_2, \ldots, B_1, B_2, \ldots) = 0,
    \label{eq:ab-equilibrium}
\end{equation}
这个方程的解集却不显含$C_2, C_3, \ldots$。\eqref{eq:ac-and-bc-equilibrium}能够推导出\eqref{eq:ab-equilibrium}，因此\eqref{eq:ac-and-bc-equilibrium}的解集只应该是\eqref{eq:ab-equilibrium}的解集的子集。
既然\eqref{eq:ab-equilibrium}的解集不显含任何关于系统$C$的信息，\eqref{eq:ac-and-bc-equilibrium}的解集当然也不应该显含任何关于系统$C$的信息。
因此实际上\eqref{eq:ac-and-bc-equilibrium}不显含$C_2, C_3, \ldots$。这样\eqref{eq:ac-and-bc-equilibrium}实际上就是
\[
    F_{AC} (A_1, A_2, \ldots) = F_{BC} (B_1, B_2, \ldots).
\]
既然$F_{AC}$和$F_{BC}$实际上和系统$C$无关，我们可以重命名它们，得到
\begin{equation}
    \Theta_A (A_1, A_2, \ldots) = \Theta_B (B_1, B_2, \ldots).
    \label{eq:thermodynamics-temperature}
\end{equation}
\eqref{eq:thermodynamics-temperature}等价于\eqref{eq:ac-and-bc-equilibrium}，它成立的充要条件是存在某个已平衡的系统$C$，使得$A$和$C$热平衡且$B$和$C$热平衡。
因此，\eqref{eq:thermodynamics-temperature}是“$A$和$B$热平衡”的充分条件，从而也是\eqref{eq:ab-equilibrium}的充分条件。
另一方面，\eqref{eq:thermodynamics-temperature}是一个仅含有$A$的状态函数和$B$的状态函数的单个方程，而\eqref{eq:ab-equilibrium}也是这样的单个方程，它们在热力学坐标空间中画出来的轨迹或者仅有可数个交点，或者完全重叠。
\eqref{eq:thermodynamics-temperature}是\eqref{eq:ab-equilibrium}的充分条件这件事意味着实际情况不可能是前者，因此我们得到最终的结论：
\eqref{eq:thermodynamics-temperature}是系统$A$和$B$热平衡的充要条件。

如果一个系统可以看成若干个子系统接触之后的产物，那么当这个系统平衡后，其子系统的温度就是这个系统的温度。
这是因为记该系统（称为系统$A$）温度为$\Theta$，现在使用另一个温度为$\Theta$的系统（称为系统$B$）与之接触，显然，系统$B$一定会和系统$A$的某个子系统接触，而既然系统$A$和系统$B$温度一致，如前所述，它们接触后立即达到热平衡，相应的，系统$B$和与之接触的$A$的子系统接触后立即达到热平衡，因此能够和$B$发生接触的所有$A$的子系统必定具有温度$\Theta$；$A$的子系统相互接触，因此它的所有子系统都有温度$\Theta$。
需注意以上论证建立在$A$的几个子系统确实相互接触的前提之上。例如，真空中被红外光反射镜隔开的两个物体可以具有不同的温度，而与此同时它们组成的总系统又确实达到了热平衡，因为这两个物体不能发生有效的相互作用。

\eqref{eq:thermodynamics-temperature}中的$\Theta$是系统的一些状态函数的函数，因此它也是一个状态函数。我们称其为\textbf{温度}。实际上，\eqref{eq:thermodynamics-temperature}对具体的计算毫无作用——有无数种满足它的状态函数$\Theta$。\eqref{eq:thermodynamics-temperature}——从而热力学第零定律——的作用是提供一个存在性。
我们称能够用于计算的温度定义为\textbf{温标}。

通常为了和日常生活中的“冷热”概念保持一致，我们对温度添加一个额外的要求：如果系统$A$和系统$B$接触之后能量从系统$A$流向系统$B$，%
\footnote{这里我们使用了“流动”的概念，也即认为一个系统的能量变化$\Delta E$，则与之直接接触的系统的能量变化$-\Delta E$。实际上这用到了热力学第一定律。}%
那么就认为系统$A$的温度高于系统$B$。

% TODO：实际上这人为地认定了“能量流动的方向”具有传递性，所以已经用到了热力学第二定律了。。。有待修正

\subsubsection{热力学第一定律}

% TODO:统计力学中认定平衡时能量不流动
现在我们讨论系统的能量流动。按照先前在平衡态统计物理当中的论述，能量流动意味着有相互作用，有相互作用就有相互作用能，但通常哈密顿量中的相互作用项可以略去，从而我们仍有能量可加性。

\textbf{热力学第一定律}指出：能量流动可以分成两部分。一部分称为\textbf{功}，它的大小可以写成若干个形如$X_i \dd{Y_i}$的项的和；另一部分称为\textbf{热量}，它没有特殊的表达式。两个量都是从一个系统到另外一个系统的流，也即，如果在一个过程中，某个系统得到了一个功$W$或者热量$Q$，那么与之接触的其它系统（也就是所谓的外界）必定失去了等量的功或者热量，或者等价地说，得到了$-W$或者$-Q$的功或者热量；并且，功和热量具有可加性。对单个系统，记$W$和$Q$分别是它得到的功和热量，则存在一个称为\textbf{内能}的状态函数，使得
\begin{equation}
    \dd{U} = \delta{Q} + \sum_i X_i \dd{Y_i} = \var{Q} + \var{W}.
    \label{eq:thermodynamics-first-law}
\end{equation}

我们使用$\delta$表示热量和功的微元是因为一般来说热量微元不是一个恰当微分形式%
\footnote{一些物理量可以最终写成密度算符的函数，如总能量、熵等，它们完全由系统的状态确定，称为状态函数或状态量；另一些物理量是在一个过程中得到定义的，如功、冲量，其通式为
\[
    X(S_1 \longrightarrow S_2) = \int_{S_1}^{S_2} \sum_i Y_i \dd{Z_i},
\]
或者写成微分形式
\[
    \var{X} = \sum_i Y_i \dd{Z_i},
\]
其中$B_i$和$C_i$为状态量。有一些过程量实际上是状态量的变化，例如“能量的变化”
\[
    \Delta E (S_1 \longrightarrow S_2) = \int_{S_1}^{S_2} \dv{E}{t} \dd{t},
\]
但并非所有过程量都对应状态量的变化。一个过程量是某个状态量的变化量当且仅当该过程量的微元是一个恰当微分形式。}%
，从而一个过程中的热量通常并不是某个状态函数的变化量。

热力学第一定律区分了热量和做功两种传递能量的方式。这两种方式在改变内能这件事上是等价的。如果在一个过程中，体系初末内能一致，那么我们就有
\[
    \int \var{Q} + \int \var{W} = 0,
\]
也即，体系吸热等于体系对外做功（外界对体系做功的相反数）。我们称这是将热量转化为了功；类似的也可以说，功可以转化为热量。
然而，这样的转化并不是毫无限制的。我们马上会看到这样的转化过程受到什么样的限制。

\subsubsection{热力学第二定律的两种表述}

本节讨论关于熵的话题。我们将首先引入一个看起来相当唯象的假设，然后证明它有多种等价形式，然后得到一个温标和热力学熵，从而导出使用熵表述的热力学第二定律。
最后，通过证明统计力学中的温度和熵实际上就是这个温标和热力学熵，我们就证明了热力学第二定律可以建立在统计力学之上。

我们有这样一个定律，称为\textbf{热力学第二定律的开尔文表述}：不可能有一个等温过程能够将单一热源的热量完全转化为功而不产生其它变化。

这个定律的另一个等价形式，称为\textbf{热力学第二定律的克劳修斯表述}，是：热量不能从低温系统流向高温系统而不产生其它影响。

我们来论证这两个说法的等价性。首先假设有这样一个过程，能够将单一热源的热量完全转化为功而不产生其它变化。我们知道有很多装置都可以把功完全转化成热，比如说摩擦生热。
把这两个过程连起来，也就是：
\begin{enumerate}
    \item 首先从某个温度为$\Theta_1$的热源吸取热量$Q$；
    \item 然后将这部分热量变成功$W=Q$；
    \item 然后把这部分功通过摩擦生热之类的的方式完全变成热量而传递给一个温度为$\Theta_2$的系统。
\end{enumerate}
我们这样就获得了一个装置，可以随意地将一部分热量从任意一个系统转移到另一个系统，而且没有产生其它变化。因此我们可以随意地将热量从低温系统转移到高温系统而不产生其它变化。
因此如果开尔文表述不成立，那么克劳修斯表述也不成立。

再考虑另一种情况。假定克劳修斯表述不成立，也就是我们能够找到一个过程，让热量从一个低温系统流向高温系统。那么，我们可以把这个过程和一个普通的\textbf{热机}——也就是吸收一定热量、对外做功，然后再释放一定热量，如此不断循环的设备——连接起来，形成这样的一个过程：
\begin{enumerate}
    \item 低温热源将热量$Q$传递给高温热源；
    \item 热机从高温热源吸收热量$Q$（总是可以做到，只需要让热机的温度低于高温热源温度即可）；
    \item 热机对外做功$W$；
    \item 热机向低温热源排放热量$Q-W$（是这个数值是因为热力学第一定律；能够排放热量是因为可以让热机的温度介于高温热源和低温热源之间）。
\end{enumerate}
在这样的过程中，高温热源总的来说没有吸收也没有释放热量；低温热源损失了$Q-(Q-W)=W$的热量；对外做功为$W$。
这个过程从单一热源，也就是低温热源，吸收了热量$W$，使之全部变成了对外做的功，因此违背了开尔文表述。
因此如果克劳修斯表述不成立，那么开尔文表述也不成立。

总之，克劳修斯表述和开尔文表述是同一条定律——也就是\textbf{热力学第二定律}——的不同说法，这条定律禁止某些“太神奇了而不大可能是真的”的物理过程，比如说让海水温度略微下降从而产生足够全人类用上一段时间的功。

\subsubsection{热机效率、过程可逆性和热力学温度}

我们还将看到，热力学第二定律对热机的效率产生了一个很自然的限制。

我们设一台热机在它的循环往复的运作过程中从一些与之接触的系统吸收了热量$Q_1$，又向一些与之接触的系统释放了热量$Q_2$（称为\textbf{废热}，因为这一部分热量没有转化为功）。由热力学第一定律，我们有
\begin{equation}
    W = Q_1 - Q_2,
\end{equation}
$W$是热机对外做的功。定义热机的效率为
\begin{equation}
    \eta = \frac{W}{Q_1} = 1 - \frac{Q_2}{Q_1}.
    \label{eq:heat-efficienty}
\end{equation}
$Q_2$不可能是零，否则在热机的一个循环中，若我们将热机从中吸热的系统看成一个总系统，那么热机就从一个单一系统中吸收热量$Q_1$，然后把它全部转化为了功。
这表明$Q_2>0$，于是任何一个热机的效率都不可能达到1。
现在的问题是，热机的效率是否有一个上限？

我们首先考虑一类特殊的热机，称为\textbf{可逆热机}，也就是循环过程是可逆过程的热机。
所谓可逆过程，指的是一种颠倒过来也完全可以发生的过程。
实际上，一个过程是可逆的，当且仅当，该过程中的每一段从初态运行到末态之后，都有另一个过程可以将此末态转移到初态而抵消这一段过程对外界的所有影响。
这两个说法的等价性论证如下：如果一个过程颠倒过来可以发生，那其中的任何一段也可以颠倒过来发生，于是该过程中的任何一段从初态运行到末态之后只需要执行这一段过程颠倒后所得的过程，就从末态转移到了初态，而两个彼此颠倒的过程对外界的影响相互抵消了；
反之，如果一个过程中的每一段从初态运行到末态之后，都有另一个过程可以将此末态转移到初态而抵消这一段过程对外界的所有影响，那么我们取一个过程微元，能够找到另一个过程微元，使得先作用前者再作用后者之后系统状态恢复而环境状态也恢复；但由微元的性质，后者和前者相差的是一个高阶小量% TODO:进一步说明，以及为什么可逆意味着准静态
，从而后者实际上就是前者颠倒过来的结果，因此该过程中的每一个微元都是可以颠倒的，从而整个过程也是可以颠倒的。

直觉上，可逆过程一般意味着比较少的能量转化为了不得不排放到外界的废热$Q_2$。例如，废热的一个重要产生途径为摩擦生热，而摩擦不是一个可逆的过程（摩擦将功转化为了热，而由热力学第二定律热不能转化为功而不对外界产生影响）。因此不慎严格地说，可逆过程意味着摩擦等非理想因素被完全排除。
但我们现在在讨论热力学，我们并不细致地去分析什么样的过程会导致不可逆性；同样我们也将使用完全基于热力学而不基于任何具体的物理理论的论证来表明可逆热机的特殊性质。

我们有结论：同样条件下（例如，同样温度的热源、同样的输入热量），没有一台热机能够具有比一台可逆热机更好的效率。
这是热力学第二定律的推论。设可逆热机$A$从热源1吸收热量$Q$之后可以做功$W$，然后向热源2排放热量$Q-W$。%
\footnote{热源1和热源2可能分别是由几个温度不等的小热源组成的，而未必是完全均匀的。}%
假设有一台效率比$A$还要好的热机$B$，则它从热源1吸收热量$Q$之后可以做功$W'$，$W'>W$。由于$A$是可逆的，它也可以从另一个热源吸收热量$W-Q$，接受外界做功$W$，然后向热源1排放热量$Q$。
那么我们可以构造下面的过程：
\begin{enumerate}
    \item 热机$B$从热源1吸热$Q$，向热源2排热$Q-W'$，同时做功$W'$；
    \item 功$W'$中，$W'-W$的部分被用于向外做功，$W$被输入热机A；
    \item 热机$A$接受$B$做的功$W$，从热源2吸热$W-Q$，向热源1排热$Q$。
\end{enumerate}
整个过程向外做功$W'-W$，热源1无净热量得失，热源2损失热量$W'-W$。也即，这个过程从单一热源吸热而将其全部转化为了功，因而违背了热力学第二定律。
因此不存在这样的热机$B$，也就是说没有效率比$A$还要高的热机。

现在有两台可逆热机$A$和$B$。同样条件下$A$的效率不可能高于$B$，$B$的效率也不可能高于$A$，因此两者的效率是一样的。也即，所有可逆热机在同样的条件下都具有同样的效率。
于是我们得出结论：任何可逆热机在同样的条件下都具有同样的效率，且这个效率是该条件下一切热机能够达到的最大效率。

这个结论其实让人感到惊奇，因为我们没有用到任何关于热机的具体原理的知识。例如，我们从来不需要讨论什么是摩擦、什么是不可逆过程，我们只需要使用抽象的“可逆”概念就可以了。

以上结论实际上还可以进一步加强：热机是可逆的是热机效率最大化的充要条件（而不仅仅是充分条件）。理由也很简单。设有一台不可逆热机也能够达到

虽然我们在做以上推导时，都是对可逆热机和不可逆热机输入了同样的热量，比较它们做的功，但实际上可逆热机的效率和输入热量是无关的。要看出为什么，设一台可逆热机从某热源吸热$Q$而做功$W$。如果效率和输入热量有关，就有
\[
    W = \eta(Q) Q.
\]
我们也可以使用两台一样的这种可逆热机，进行下面的操作：
\begin{enumerate}
    \item 从热源吸热$Q$；
    \item 将热量$Q$分成两份$Q_1$和$Q_2$；
    \item 将$Q_1$提供给其中一台可逆热机，由它对外做功$W_1$；
    \item 将$Q_2$提供给另一台可逆热机，由它对外做功$W_2$。
\end{enumerate}
这样一来，对外做的总功为
\[
    W' = \eta(Q_1) Q_1 + \eta(Q_2) Q_2, \quad Q_1 + Q_2 = Q.
\]
由于将热量分成两束、将两台可逆热机的功合并在一起都是可逆的，以上过程也是可逆的。由于任何可逆热机在相同条件下都应该具有一样的效率，我们有
\[
    W = W'.
\]
从而，对任意满足$Q_1 + Q_2 = Q$的$Q_1, Q_2$，都有
\[
    \eta(Q) Q = \eta(Q_1) Q_1 + \eta(Q_2) Q_2.
\]
唯一的可能就是，$\eta$实际上并不显含$Q$。因此可逆热机的效率和输入热量无关。从而，可逆热机输出的功、排出的废热和输入热量成正比关系。

现在我们考虑只涉及两个温度确定的热源的可逆热机，称为\textbf{卡诺热机}。通过考虑这种类型的热机，我们实际上可以获得一个温标，同时获得热力学第二定律的一个显式表达式。
卡诺热机的效率和热机具体的构造无关（正如我们刚刚证明的那样），因此其效率只和两个热源的温度$\Theta_1$和$\Theta_2$有关。因此，在热源温度已知的情况下，只需要知道可逆热机吸收了多少热量，我们就知道它会对外做多少功、会对外排放多少热量。
现在考虑一个固定的温度$\Theta_s$，设可逆热机的两个热源分别为$\Theta_s$和$\Theta$，热机从温度为$\Theta_s$的热源吸热$Q_s$，则会向温度为$\Theta$的热源放热$Q$。%
\footnote{由于热机可逆，$\Theta_s$小于$\Theta$是没有关系的，此时只需要外界对热机做功就可以完成整个过程——这实际上就是制冷机。}%
我们已经证明过，$Q$和$Q_s$有正比关系，因此有
\begin{equation}
    Q = Q_s f(\Theta).
    \label{eq:q-s-and-theta}
\end{equation}
$f$实际上是递增的。设$\Theta_1<\Theta_2$，且对温度为$\Theta_1$和$\Theta_2$的热源热机分别放热$Q_1$和$Q_2$，由于热机的可逆性，我们可以构造如下过程：
\begin{enumerate}
    \item 从温度为$\Theta_1$的热源吸热$Q_1$，向温度为$\Theta_s$的热源放热$Q_s$；
    \item 从温度为$\Theta_s$的热源吸热$Q_s$，向温度为$\Theta_2$的热源放热$Q_2$。
\end{enumerate}
这是一个可逆过程，因此由可逆热机效率的唯一性，任何一台卡诺热机从温度为$\Theta_1$的热源吸热$Q_1$必然伴随着向温度为$\Theta_2$的热源放热$Q_2$。
这是一个热量从低温系统流向高温系统的过程，则外界必定对热机做功，因为如果外界不对热机做功，那这就违背了热力学第二定律；而如果热机对外界做功，我们显然可以把这部分功通过摩擦生热等方式转化为热量传递给温度为$\Theta_2$的热源，导致一个热量从低温系统流向高温系统而不产生其它影响的过程，同样违反热力学第二定律。
因此
\[
    Q_2 = Q_1 + \text{work done to the machine},
\]
从而
\[
    Q_2 > Q_1,
\]
也即
\[
    Q_2(\Theta_2) > Q_1(\Theta_1), \quad \text{for } \Theta_2 > \Theta_1.
\]
由于没有指定特定的温标，我们只能获得\eqref{eq:q-s-and-theta}，而不能获得更进一步的结论。
但由于温标的任意性，我们完全可以要求
\[
    f(T) \propto \Theta,
\]
从而
\[
    Q \propto Q_s \Theta,
\]
我们称满足这个条件的温标为\textbf{热力学温标}。显然，所有可能的热力学温标相互之间差一个常数因子。在热力学温标下，
这等价于
\begin{equation}
    \frac{Q_1}{T_1} = \frac{Q_2}{T_2}.
\end{equation}
一旦得到了这个关系式，我们就得到了可逆热机的效率，因为如前所述，任何一台卡诺热机从温度为$\Theta_1$的热源吸热$Q_1$必然伴随着向温度为$\Theta_2$的热源放热$Q_2$。
设$T_1>T_2$，从而$Q_1>Q_2$，可逆热机对外做功。考虑\eqref{eq:heat-efficienty}，对卡诺热机有
\begin{equation}
    \eta = 1 - \frac{T_2}{T_1}.
\end{equation}
因此对任何二热源热机，均有
\begin{equation}
    \eta \leq 1 - \frac{T_2}{T_1},
    \label{eq:efficiency-inequality}
\end{equation}
如果热机可逆则取等号。热机不可逆时是否能够取等号？结论是不行，因为如果一部不可逆的二热源热机（称为$A$）的效率和可逆热机（称为$B$）完全一致，那么可以构造这样的过程：
\begin{enumerate}
    \item $A$从高温热源吸热$Q$，向低温热源排放热量$Q'$，对$B$做功$W$；
    \item $B$倒过来运转（此时它实际上是制冷机），接受$A$做的总量为$W$的功，从低温热源吸热$Q'$，向高温热源排热$Q$。
\end{enumerate}
这样我们就让$A$在运转了一段时间之后回到了原来的状况，且高温热源和低温热源无净热量流动，$A$和$B$组成的大系统也没有对外界做功。
这和$A$是不可逆热机矛盾。因此\eqref{eq:efficiency-inequality}中的等号在且仅在热机可逆时取得。

现在我们可以讨论一个一般的热机了。设这个热机的一个循环中经历了一系列过程，每个过程中热机从温度为$T$的热源吸热$\dd{Q}$（若热机在这个步骤实际上向热源放热，则$\dd{Q}$取负值），对外做功$\dd{W}$（若反而是外界向热机做功则取负值）。
我们记这台热机为热机$A$。
现在想象我们有一个温度为$T_0$的很大的热源，这意味着其温度对有限的过程而言保持恒定，然后构造一个多步骤的循环过程，其中每一步为：
\begin{enumerate}
    \item 让一部卡诺热机从温度为$T_0$的热源吸热$\dd{Q}_0$，这部分热量正好导致卡诺热机输出热量$\dd{Q}$（若卡诺热机向$T_0$热源放热也是可以的，只需要让$\dd{Q}_0$取负值即可）；
    \item 卡诺热机输出的能量被全部传递给了热机$A$；
    \item 热机$A$输入热量$\dd{Q}$，对外做功$\dd{W}$。
\end{enumerate}
如此进行一个循环。整个循环中，每一步的$\dd{Q}$，$\dd{W}$和$T$是给定的，$\dd{Q}_0$则是根据\eqref{eq:heat-efficienty}计算出来的。
显然这个循环在任何条件下都是可以进行的，于是我们可以将$T_0$取得比较低（从而需要外界对卡诺热机做比较多的功来保持其运转，不过我们并不需要考虑这一点）。
一个循环过后必定有
\[
    \oint \var{Q}_0 \leq 0,
\]
否则能量自发地从低温热源流向高温热源，违反热力学第二定律。考虑到\eqref{eq:heat-efficienty}，我们有
\[
    \frac{\var{Q}_0}{T_0} = \frac{\var{Q}}{T},
\]
考虑到$T_0$恒定不变，我们有
\begin{equation}
    \oint \frac{\var{Q}}{T} \leq 0.
    \label{eq:clausius-inequality}
\end{equation}
虽然\eqref{eq:clausius-inequality}的导出建立在“与热机$A$接触的热源由一部卡诺热机的废热供热”的假设上，但由于热机$A$的行为完全由每一步的$\dd{Q}$和$T$决定，热机“不知道”自己是不是由一部卡诺热机供热。
那么，既然\eqref{eq:clausius-inequality}对由卡诺热机供热的热机成立，它对任何一个热机循环过程都是成立的。不等式\eqref{eq:clausius-inequality}称为\textbf{克劳修斯不等式}。

在热机可逆时，我们可以把热机的运转完全颠倒过来，做变换
\[
    \var{Q} \longrightarrow -\var{Q},
\]
而不违反任何物理定律。这就意味着
\[
    \oint \frac{-\var{Q}}{T} \leq 0,
\]
从而
\[
    \oint \frac{\var{Q}}{T} = 0.
\]
因此对可逆热机，克劳修斯不等式\eqref{eq:clausius-inequality}取等号。
不可逆热机\eqref{eq:clausius-inequality}不能取等号，否则可以使用这个不可逆热机对外做的功驱动一部可逆制冷机，从而一个循环后不可逆热机对环境的影响完全被消除而一切都恢复到了初始状态，和不可逆性矛盾。

% TODO：证明可逆过程一定是准静态的；大致的思路是，只有准静态过程才能让$\int A \dd{B}$完全扫过状态方程$A=f(B)$曲线之下的面积；
% 但仍有一些事情要做：需要论证状态方程的存在性，以及只需要使用热力学第一定律中的$A,B$等量就足以描述平衡态系统。热力学坐标到底是什么？？

最后，由于任何一个系统的循环过程实际上都是在吸热、放热、做功，任何一个在发生循环过程的系统实际上都是一台热机。于是克劳修斯不等式对任何一个循环过程都成立；取等条件为循环过程可逆。

我们使用热力学第二定律导出了克劳修斯不等式。如果热力学第二定律不成立，那么可以构造这样一个循环过程，它从低温热源$T_1$吸热$Q$而向高温热源放热$Q$，且没有接受外界做功也没有对外界做功，此时
\[
    \oint \frac{\var{Q}}{T} = \frac{Q}{T_1} - \frac{Q}{T_2} > 0,
\]
于是克劳修斯不等式就不成立了。
因此克劳修斯不等式实际上等价于热力学第二定律，或者说它是热力学第二定律的一种不等式表述。

\subsubsection{热力学熵}

既然对可逆热机，克劳修斯不等式\eqref{eq:clausius-inequality}取等号，而可逆过程一定是准静态的，从而涉及的$\var{Q}$和$T$可以写成诸热力学坐标的函数，在热力学坐标空间中我们有%
\footnote{即使对不可逆系统照样有该式成立。克劳修斯不等时中的积分是关于实际的过程的，也即
\[
    \int_\text{circle process} \frac{\var{Q}(t)}{T(t)} = \int_\text{circle process} \frac{1}{T} \frac{\var{Q}(t)}{\dd{t}} \dd{t} < 0,
\]
这和
\[
    \oint_\text{state space} \frac{\dd{U}-\var{W}}{T} = 0
\]
并无矛盾。}
\begin{equation}
    \oint \frac{\dd{U}-\var{W}}{T} = 0.
\end{equation}
因此我们可以定义一个新的状态函数$S$，称为\textbf{热力学熵}，它满足
\begin{equation}
    \dd{S} = \frac{\dd{U}-\var{W}}{T}.
    \label{eq:entropy-dd}
\end{equation}
光靠\eqref{eq:entropy-dd}是确定不下来熵的具体值的；满足这个表达式的$S$彼此差一个常数。
这样，对可逆系统而言就有
\begin{equation}
    \dd{U} = \var{S} + \var{W} = T\dd{S} + \var{W}.
\end{equation}
可逆系统和不可逆系统的热力学第一定律表达式唯一的差别就是$\var{Q}$的形式，于是系统可逆等价于
\begin{equation}
    \left(\pdv{U}{S}\right)_{Y} = T, \quad \left(\pdv{S}{U}\right)_Y = \frac{1}{T}.
    \label{eq:pdv-of-u-and-s}
\end{equation}
这里使用标准的记号，以偏导数的下标表示被认为是不变的量。

在引入热力学熵的概念之后，就可以从\eqref{eq:clausius-inequality}导出熵增原理。设有一个过程$P$，初态为$A$，末态为$B$，我们可以构造一个从$B$到$A$的可逆过程，从而形成一个循环。对这个循环应用\eqref{eq:clausius-inequality}，就得到
\[
    \int_P \frac{\var{Q}}{T} + \int_{B}^A \frac{\var{Q}}{T} \leq 0,
\]
也即
\[
    \int_P \frac{\var{Q}}{T} \leq - \int_{B}^A \frac{\var{Q}}{T} = \int_A^B \frac{\var{Q}}{T},
\]
于是就得到
\begin{equation}
    S_B - S_A \geq \int_P \frac{\var{Q}}{T}.
    \label{eq:increasing-entropy}
\end{equation}
从以上推导可以看出\eqref{eq:increasing-entropy}的取等条件就是\eqref{eq:clausius-inequality}的取等条件，也就是过程$P$连同从$B$到$A$的过程可逆，也即过程$P$可逆。
因此\eqref{eq:increasing-entropy}在过程$P$可逆时取等号。
我们使用克劳修斯不等式推导出了\eqref{eq:increasing-entropy}，而容易看出\eqref{eq:increasing-entropy}也能够反过来推导出克劳修斯不等式，这只需要让过程$P$是一个循环过程就可以，此时$S_A$和$S_B$相等，自然得到\eqref{eq:clausius-inequality}。
这里有一个微妙的细节：在导出\eqref{eq:increasing-entropy}时我们用到了\textbf{热力学熵}，而热力学熵是良定义的状态函数这件事是使用\eqref{eq:clausius-inequality}推导出来的。
因此更加准确地说，与\eqref{eq:clausius-inequality}等价的是“存在某个状态函数$S$使得不等式\eqref{eq:increasing-entropy}成立，且取等条件为过程可逆”。

在过程中无热量交换，也即，发生过程的系统与外界绝热的情况下，\eqref{eq:increasing-entropy}就是
\begin{equation}
    \Delta S \geq 0,
\end{equation}
取等条件为过程可逆。这就是所谓的\textbf{熵增原理}：绝热系统的熵永远不会减小。
实际上，虽然我们使用\eqref{eq:increasing-entropy}推导出了熵增原理，但熵增原理结合熵和热量的性质也可以推导出\eqref{eq:increasing-entropy}。设有过程$P$，初态为$A$末态为$B$，我们将它的热量交换端和一台可逆热机连接，组成一个绝热的总系统，对这个总系统应用熵增原理，有
\[
    S_\text{system, $B$} + S_\text{reversible, $B$} \geq S_\text{system, $A$} + S_\text{reversible, $A$}.
\]
对可逆过程有
\[
    \frac{\var{Q}_\text{reversible}}{T} = \dd{S},
\]
于是
\[
    \begin{aligned}
        S_\text{system, $B$} - S_\text{system, $A$} &\geq S_\text{reversible, $A$} - S_\text{reversible, $B$} \\
        &= - \int_A^B \frac{\var{Q}_\text{reversible}}{T} \\
        &= \int_A^B \frac{\var{Q}_\text{system}}{T}.
    \end{aligned}
\]
取等条件为总系统发生的过程可逆，也即过程$P$可逆。这正是\eqref{eq:increasing-entropy}。
因为发生过程$P$的系统并不知道它在和什么东西做热交换，如果以上不等式对和一台可逆热机连接的系统上发生的过程成立，那它就对一切过程均成立。

总之，以下三个结论彼此等价，且它们都是热力学第二定律的表述：
\begin{itemize}
    \item 有一个称为熵，记作$S$的状态函数，绝热系统的熵总是增加的，且对可逆过程有$\var{Q}=T\dd{S}$，或等价的\eqref{eq:pdv-of-u-and-s}；
    \item 有一个称为熵，记作$S$的状态函数，它让\eqref{eq:increasing-entropy}恒成立；
    \item 克劳修斯不等式\eqref{eq:clausius-inequality}。
\end{itemize}

\subsubsection{热力学第三定律和熵的零点}

\subsection{与统计力学的关系}\label{sec:from-statistical-to-thermo}

现在我们开始考虑具体的系统的结构，而不只是凭借对“系统”、“热”等概念的直觉行事。
本节将考虑\autoref{sec:equilibrium-system}中提到的系统。为了保持一般性，我们将讨论可以和外界交换守恒荷的系统，也即，平衡时需要使用巨正则系综描述的系统。
我们总是这样选择系统的范围，让系统和外界的相互作用哈密顿量相对于系统自己的哈密顿量来说并不大。

\subsubsection{从统计力学推导出热力学}

首先要问的是，热力学是不是对\autoref{sec:equilibrium-system}中提到的系统成立？

首先看热力学第一定律。在热力学中我们没有给出区分热量和功的方法，而只是笼统地讨论了“热量需要满足如何如何的性质，功要满足如何如何的性质”。实际上我们也没有定义内能。
因此我们需要指出，热力学量在统计力学中的确有对应物。

% TODO:温度

接着来看热力学第一定律和热力学第二定律，也即，功、热量、内能的概念。
热力学第一定律\eqref{eq:thermodynamics-first-law}中提到，功可以看成某个广义力乘上某个热力学坐标的变化量。所谓热力学坐标在统计物理中应当是关于系统的某些参数。这些参数无非属于下面三类：
\begin{itemize}
    \item \autoref{sec:grand-canonical-ensemble}中提到，系统中的守恒荷决定系统可能处于的量子态，因此它们的期望值是热力学参数；% TODO：如守恒荷的涨落等物理量都是可以使用它们计算出来的
    \item 和哈密顿量有关但并非守恒荷的参数，例如对盒中气体而言，体积就是一个这样的参数，它确定了势阱的大小，从而影响气体的动力学，但是并不是守恒荷；
    \item 大量粒子涌现出来的物理量，如温度、化学势等，它们有可能在非平衡态时难以良好定义。
\end{itemize}
第一类的热力学坐标使用$\{N_i\}$表示，第二类的热力学坐标使用$\{q_i\}$表示。

现在我们认定：内能$U$就是系统的平均能量$\bar{E}$，并且%
\footnote{这里我们把$N_i$也就是$\expval*{\hat{N}_i}$当成了$\hat{H}$的一个参数，% TODO：为什么可以这么做？？
}
\[
    \dd{U} = \underbrace{\sum_i \expval{\pdv{\hat{H}}{q_i}} \dd{q_i} + \sum_i \expval{\pdv{\hat{H}}{N_i}} \dd{N_i}}_{\var{W}} + \underbrace{\text{others}}_{\var{Q}}.
\]
$\bar{E}$确实是一个状态函数，因此我们这就定义了内能、功和热量。这样定义的功和热量是不是系统之间的流动？
答案是肯定的。首先我们来说明这样定义的功确实是系统和外界之间的流动。由于系统和外界组成的总系统的哈密顿量自身是守恒量，我们有
\[
    \expval*{\hat{H}+\hat{H}_\text{out}+\hat{H}_\text{int}} = 0.
\]
如前所述，相互作用哈密顿量相对于系统自身的哈密顿量来说并不大（但必须要有，否则系统和外界不能交换能量），所以
\[
    \expval*{\hat{H}+\hat{H}_\text{out}} = 0.
\]
这样就有
\[
    \expval{\pdv{\hat{H}}{q_i}} = - \expval{\pdv{\hat{H}_\text{out}}{q_i}}.
\]
同样
\[
    \expval{\pdv{\hat{H}}{N_i}} = - \expval{\pdv{\hat{H}_\text{out}}{N_i}}.
\]
总之，各个参数$\{q_i\}$和$\{N_i\}$是功传递的渠道。如果系统通过某个参数的改变获得了一定功，那么外界通过这个参数的改变就会得到正负号相反的功。这表明功确实在系统和外界之间流动。

按照内能的定义，我们还有
\[
    \dd{U}+\dd{U}_\text{out} = 0,
\]
我们有
\[
    \dd{U} = \var{W} + \var{Q}, \quad \dd{U}_\text{out} = \var{W}_\text{out} + \var{Q}_\text{out},
\]
如前所述，有（这里的$\var{W}_\text{out}$指的是由于外界和系统相互作用而得到的功，即系统向外界做的功）
\[
    \var{W} = - \var{W}_\text{out},
\]
从而
\[
    \var{Q}_\text{out} = - \var{Q},
\]
从而热量也在系统和外界之间流动。%TODO：可加性？？

总之，按照以上方法定义的内能、功、热量完全符合热力学第一定律的要求。它们是否也符合热力学第二定律的要求？
首先考虑一个演化过程始终是平衡态的过程。我们有
\[
    \var{Q} = \dd{U} - \var{W},
\]
使用$\beta$和$\alpha$为变量，我们有
\[
    \var{Q} = \dd{\left( - \pdv{\ln\Xi}{\beta} \right)} - 
\]
% 平衡态好做

% TODO，尤其是热力学第二定律。为什么熵增？可能的解释是，平衡态的数目比非平衡态要多。

\subsubsection{自然热力学坐标}

\begin{equation}
    \dd{U} = T \dd{S} + \sum_i F_i \dd{q_i} + \sum_i \mu_i \dd{N_i}.
\end{equation}
% 什么时候可以不考虑化学势之类的东西？？
% TODO：U, q, N

% TODO:分子分解、合成实际上就是原子的重新组合，有$s$种原子，就可以选取$s$种分子的粒子数作为热力学坐标，然后就能够计算出

% TODO：热力学势、自由能，其它几种状态函数

\subsection{热力学与材料本构关系}

\subsection{相与相变}

\section{近平衡态理论}

% TODO:随机过程和轨道。
% $P(\text{event $A$ occurs at $t$})=P_t(\text{event $A$ occurs})$，前者定义为“所有$A$发生在时间$t$处的轨道总数除以轨道总数”，后者定义为“时间$t$处，$A$发生的概率”，由定义两者相等。

% TODO：比较平衡态、非平衡态、实时、虚时，各种formalism，零温、有限温，等等

\subsection{线性响应}

\subsubsection{推迟格林函数}

设我们在体系中加入一个微扰$\hat{A}$：
\begin{equation}
    \hat{H}' = \hat{H} - h(t) \hat{A},
\end{equation}
其中$h(t)$是一个含时的系数。我们要求$h(t)$被缓慢地施加，而又缓慢地被撤去，从而系统初态（也即，$t=-\infty$时的状态）可以看成平衡态。
记密度算符$\hat{\rho}$在$t=-\infty$时的状态为$\hat{\rho}_0$。
显然微扰会改变系统的行为。计算受到微扰的系统中某不含时的可观察量$\hat{B}$的期望偏离平衡态的程度（下标0表示这是对没有加过微扰的系统取平均，也就是按照$\hat{\rho}_0$取平均）：
\[
    y(t) = \expval*{\hat{B}}(t) - \expval*{\hat{B}}_0 = \trace\left((\hat{\rho} - \hat{\rho}_0)\hat{B}\right).
\]
前面提到这是微扰，因此$y(t)$和$h(t)$的关系近似是线性的（这就是我们正在讨论的理论称为\textbf{线性响应}理论的原因），从而我们可以使用一个格林函数联系两者，即
\[
    y(t) = \int \dd{t'} G(t, t') h(t').
\]
我们要求系统具有因果律，这意味着，在$t<t'$时应有$G(t,t')=0$，否则某一时刻的$h(t')$将会影响过去时间的$y(t)$。因此我们有
\[
    G(t,t') \propto \Theta(t-t'),
\]
且积分可以写成
\[
    y(t) = \int_{-\infty}^t \dd{t'} G(t, t') h(t').
\]

切换到相互作用绘景下。取$\hat{H}$为自由哈密顿量，$-h(t)\hat{A}$为相互作用哈密顿量，那么演化方程就是
\[
    \dv{\hat{\rho}^I}{t} = \frac{\ii}{\hbar} \comm*{\hat{\rho}^I}{-h(t)\hat{A}^I(t)} = \frac{\ii}{\hbar} h(t) \comm*{\hat{A}^I(t)}{\hat{\rho}^I}.
\]
上式等价于积分方程
\[
    \hat{\rho}^I(t) = \hat{\rho}_0^I + \frac{\ii}{\hbar}  \int_{-\infty}^t \dd{t'} h(t') \comm*{\hat{A}^I(t')}{\hat{\rho}^I(t')}.
\]
事实上，$\hat{\rho}_0^I$就是$\hat{\rho}_0$，因为$\hat{\rho}_0$的一般形式为
\[
    \hat{\rho}_0 = \frac{1}{Z} \ee^{-\beta \hat{H} + \sum_i \mu_i \hat{N}_i},
\]
从而
\[
    \hat{\rho}_0^I = \ee^{\frac{\ii}{\hbar}t \hat{H}} \hat{\rho}_0 \ee^{-\frac{\ii}{\hbar}t \hat{H}} = \hat{\rho}_0.
\]
由于$h(t)$非常小，$\hat{\rho}^I$的变化不是特别大，于是取以上方程的一阶近似，得到
\[
    \hat{\rho}^I(t) = \hat{\rho}_0 + \frac{\ii}{\hbar}  \int_{-\infty}^t \dd{t'} h(t') \comm*{\hat{A}^I(t')}{\hat{\rho}_0}.
\]
于是可以计算出$y(t)$：
\[
    \begin{aligned}
        y(t) &= \trace \left\{ (\hat{\rho}^I(t) - \hat{\rho}^I_0) \hat{B}^I(t) \right\} \\
        &= \frac{\ii}{\hbar} \int_{-\infty}^t \dd{t'} h(t') \trace \left\{ \comm*{\hat{A}^I(t')}{\hat{\rho}_0} \hat{B}^I(t) \right\},
    \end{aligned}
\]
利用迹运算的轮换性，得到
\[
    \trace \left\{ \comm*{\hat{A}^I(t')}{\hat{\rho}_0} \hat{B}^I(t) \right\} = \trace \left\{ \hat{\rho}_0 \comm*{\hat{B}^I(t)}{\hat{A}^I(t')} \right\},
\]
于是最终得到
\[
    \begin{aligned}
        y(t) &= \frac{\ii}{\hbar} \int_{-\infty}^t \dd{t'} h(t') \trace \left\{ \hat{\rho}_0 \comm*{\hat{B}^I(t)}{\hat{A}^I(t')} \right\} \\
        &= \frac{\ii}{\hbar} \int_{-\infty}^t \dd{t'} h(t') \expval*{\comm*{\hat{B}^I(t)}{\hat{A}^I(t')} }_0.
    \end{aligned}
\]
最后，注意到以$\hat{H}$为自由哈密顿量的相互作用绘景中的算符实际上就是以$\hat{H}$为哈密顿量的海森堡绘景中的算符，于是我们写出$y(t)$和$h(t')$之间的格林函数：
\[
    G(t,t') = \frac{\ii}{\hbar} \Theta(t-t') \expval*{\comm*{\hat{B}^H(t)}{\hat{A}^H(t')}}_0.
\]
为了更加明确，通常使用下面的记号：
\begin{equation}
    G(t,t')^\text{ret}_{BA} = \frac{\ii}{\hbar} \Theta(t-t') \expval*{\comm*{\hat{B}(t)}{\hat{A}(t')}}.
    \label{eq:retarded-green-function}
\end{equation}
上标ret表示这是\textbf{推迟格林函数}（retarded），下标表示扰动和响应。所谓“推迟”不代表该格林函数在时间上是非局域的，而是表示向后的因果性。
默认体系不受到微扰，且算符$\hat{A}$和$\hat{B}$默认处于无微扰的海森堡绘景中，于是略去期望值的下标0和算符的上标。

实际我们做实验分析一个系统的性质时，都是对系统施加某个输入（敲它以下、加上一个磁场、通电，等等），然后测量对应的响应，因此只需要计算出我们关心的过程（例如，外加电场会导致通电，即外加$\vb*{E}$导致$\vb*{j}$）的推迟格林函数，就确定了这个过程的性质。只需要推迟格林函数就够了。于是接下来来分析推迟格林函数的性质。

\subsubsection{涨落耗散定理}

本节展示推迟格林函数的一个非常重要的性质。采取海森堡绘景，定义两个算符的\textbf{关联函数}为
\begin{equation}
    S_{BA}(t,t') = \expval*{\hat{B}(t)\hat{A}(t')} - \expval*{\hat{B}(t)}\expval*{\hat{A}(t')}.
\end{equation}
我们可以不失一般性地对各个算符做一个平移，从而让它们的期望值为零，即做变换
\[
    \hat{A} \longrightarrow \var{\hat{A}} = \hat{A} - \expval*{\hat{A}},
\]
于是不失一般性地认为所有算符的期望值都为零，从而
\begin{equation}
    S_{BA}(t,t') = \expval*{\hat{B}(t)\hat{A}(t')}.
\end{equation}

由于哈密顿量不含时，我们有时间平移对称性，于是
\begin{equation}
    G_{BA}^\text{ret}(t,t') = G_{BA}^\text{ret}(t-t'), \quad S_{BA}(t,t') = S_{BA}(t-t').
\end{equation}
于是可以定义一个单变量傅里叶变换：
\begin{equation}
    S_{BA}(\omega) = \int_{-\infty}^\infty \dd{t} S_{BA}(t) \ee^{\ii \omega t}, \quad G_{BA}^\text{ret}(\omega) = \int_{-\infty}^\infty \dd{t} G_{BA}^\text{ret}(t) \ee^{\ii \omega t}.
\end{equation}
实际上由\eqref{eq:retarded-green-function}，
\[
    G_{BA}^\text{ret}(\omega) = \int_0^\infty \dd{t} G_{BA}^\text{ret}(t) \ee^{\ii \omega t}.
\]
那么，我们有\textbf{涨落耗散定理}：
\begin{equation}
    \Im G_{BA}^\text{ret}(\omega) = \frac{1 - \ee^{-\beta\hbar\omega}}{2\hbar} S_{BA}(\omega).
\end{equation}

下面我们来证明这一点。首先注意到，$h(t)$和$y(t)$都是实数，从而联系它们的推迟格林函数也一定是实数，这样就有

% TODO
\subsubsection{Kramers-Kronig关系}

实际上，推迟格林函数的实部和虚部也有关系。要看出这个关系只需要利用推迟格林函数的两个性质：
\begin{itemize}
    \item 因果性，即$G_{BA}^\text{ret}(t)$在$t<0$时为零；
    \item 频谱至少衰减得和$1/\omega$一样快，这个条件实际上需要额外的确认，但通常是成立的，因为当
\end{itemize}

第一个条件，也就是，因果律，意味着$G_{BA}^\text{ret}(\omega)$在上半平面上是解析的。这是因为
\[
    G_{BA}^\text{ret}(t) = \frac{1}{2\pi} \int_{-\infty}^\infty \dd{t} G_{BA}^\text{ret}(\omega) \ee^{-\ii\omega t},
\]
在$t<0$时能够保证在上半平面上，$\omega\to\inf$时$\ee^{-\ii \omega t}$快速衰减，于是
\[
    G_{BA}^\text{ret}(t) = \frac{1}{2\pi} \cdot 2 \pi \sum_\text{upper plane}  \Res G_{BA}^\text{ret}(\omega) \ee^{-\ii\omega t},
\]
在$t<0$时上式一定是零，从而上半平面上必定没有奇点，从而$G_{BA}^\text{ret}(\omega)$在上半平面上是解析的。
相应的，如果系统不是平凡的，那么下半平面一定有奇点，因为$t<0$时应当在下半平面取留数。

现在考虑积分
\[
    \int_{-\infty}^\infty \dd{\omega'} \frac{G_{BA}^\text{ret}(\omega')}{\omega' - \omega + \ii 0^+},
\]
被积函数仅有的奇点位于下半平面，因此它在上半平面和实轴上处处解析，从而
\[
    \oint \dd{\omega'} \frac{G_{BA}^\text{ret}(\omega')}{\omega' - \omega + \ii 0^+} = 0.
\]
另一方面，设$C$是上半平面上的辐角从$0$到$\pi$的大圆弧，由于$G_{BA}^\text{ret}(\omega)$衰减得很快，由大圆弧引理，
\[
    \int_C \dd{\omega} \frac{G_{BA}^\text{ret}(\omega')}{\omega' - \omega + \ii 0^+} = 0.
\]
那么，取实轴和大圆弧组成一个闭合回路，在这个闭合回路上的积分是零，在大圆弧上的积分还是零，于是实轴上的积分也是零，
\[
    \int_{-\infty}^\infty \dd{\omega'} \frac{G_{BA}^\text{ret}(\omega')}{\omega' - \omega + \ii 0^+} = 0.
\]
而这个积分可以通过经典的“将奇点移动到实轴而改变积分路径”的方法计算出来，或者等价地，使用公式
\[
    \frac{1}{\omega'-\omega+\ii 0^+} = \primevalue \frac{1}{\omega'-\omega} - \pi \ii \delta(\omega'-\omega),
\]
其中$\primevalue$表示柯西积分主值，就得到
\[
    0 = \int_{-\infty}^\infty \dd{\omega'} \left( \Re G_{BA}^\text{ret}(\omega') + \ii \Im G_{BA}^\text{ret}(\omega') \right) \left( \primevalue \frac{1}{\omega'-\omega} - \pi \ii \delta(\omega'-\omega) \right),
\]
分别取实部和虚部，就得到
\begin{equation}
    \begin{bigcase}
        \Re G_{BA}^\text{ret}(\omega) &= \frac{1}{\pi} \primevalue \int_{-\infty}^\infty \dd{\omega'} \frac{\Im G_{BA}^\text{ret}(\omega')}{\omega' - \omega}, \\
        \Im G_{BA}^\text{ret}(\omega) &= - \frac{1}{\pi} \primevalue \int_{-\infty}^\infty \dd{\omega'} \frac{\Re G_{BA}^\text{ret}(\omega')}{\omega' - \omega}.
    \end{bigcase}
\end{equation}
因此，推迟格林函数的实部和虚部之间可以相互换算。

总之，在频域上，推迟格林函数的实部、虚部和关联函数这三者是一一对应的，因此实际的自由度只有一个。

\subsubsection{谱函数}

定义
\begin{equation}
    A_{BA}(\omega) = \frac{1}{\pi} \Im G_{BA}^\text{ret}(\omega)
\end{equation}
为\textbf{谱函数}。当然，推迟格林函数可以很容易地使用谱函数表示出来：
\begin{equation}
    \begin{bigcase}
        \Re G_{BA}^\text{ret}(\omega) &= \primevalue \int_{-\infty}^\infty \dd{\omega'} \frac{A_{BA}(\omega)}{\omega'-\omega} , \\
        \Im G_{BA}^\text{ret}(\omega) &= \pi A_{BA}(\omega).
    \end{bigcase}
\end{equation}
或者，考虑到
\[
    \frac{1}{\omega'-\omega-\ii 0^+} = \primevalue \frac{1}{\omega'-\omega} + \ii \pi \delta(\omega'-\omega),
\]
就是
\begin{equation}
    G_{BA}^\text{ret}(\omega) = \int_{-\infty}^\infty \dd{\omega'} \frac{A_{BA}(\omega')}{\omega' - \omega - \ii 0^+}.
\end{equation}
当$\omega\to 0$时，我们有
\[
    G_{BA}^\text{ret}(\omega) \sim \int_{-\infty}^\infty \dd{\omega'} \frac{A_{BA}(\omega')}{\omega' - \ii 0^+},
\]
而当$\omega\to \infty$时，我们有
\[
    G_{BA}^\text{ret}(\omega) \sim - \int_{-\infty}^\infty \dd{\omega'} \frac{A_{BA}(\omega')}{\omega},
\]
这表明外加驱动频率很低时和外加驱动频率很高时产生的响应的正负号是反的。这是谐振子对外加驱动的响应的一种推广：当驱动频率很小时，体系能够很好地跟上外加驱动，当驱动频率特别大时，体系几乎总是落在外加驱动后面。

从谱表示出发可以获得涨落耗散定理的另一个证明。设哈密顿量被对角化为
\[
    \hat{H} \ket{n} = E_n \ket{n},
\]
\[
    A_{BA}(\omega) = \frac{1}{\hbar Z} \sum_{m,n} \left( \ee^{-\beta E_m} - \ee^{-\beta E_n} \right) \mel{m}{\hat{B}}{n} \mel{n}{\hat{A}}{m} \delta\left( \omega + \frac{E_m - E_n}{\hbar} \right),
\]

% 怎么莫名其妙冒出来一个费米子格林函数？

\end{document}